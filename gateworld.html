<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iTabs Quote Estimator</title>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIDGET CONFIG ‚Äî Gateworld Perth
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WIDGET_CONFIG = {

  business: {
    name: "Gateworld Perth",
    tagline: "Gates, Automation & Access Control",
    phone: "",
    email: "",
    logo: "",
    website: "https://gateworld.com.au",
    location: "Perth, WA",
    socials: { facebook: "https://facebook.com/gateworldperth", instagram: "", google: "" }
  },

  branding: {
    mode: "dark",
    primaryColor: "#e2b857",
    secondaryColor: "#d4a840",
    backgroundColor: "#0f1219",
    cardBackground: "#181d27",
    hoverBackground: "#1e2535",
    darkBackground: "#0b0e14",
    borderColor: "#262f3d",
    textColor: "#eaeef3",
    mutedText: "#8a95a8",
    dimText: "#576275",
    successColor: "#22c55e",
    errorColor: "#ef4444",
    infoColor: "#3b82f6",
    fontFamily: "'DM Sans', sans-serif",
    monoFont: "'JetBrains Mono', monospace",
    borderRadius: "14px",
    googleFontsUrl: "https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap",
  },

  header: {
    icon: "üö™",
    headline: "How much is my gate?",
    subtitle: "Answer a few quick questions and get a ballpark estimate ‚Äî no obligation, takes about 90 seconds.",
    badge: "üìç Prices based on Perth, WA ‚Äî 2025",
    disclaimer: "Estimates are approximate. Final pricing confirmed after site inspection.",
  },

  steps: [
    // ‚îÄ‚îÄ STEP 1: Gate Type ‚îÄ‚îÄ
    {
      id: "gate_type",
      title: "What type of gate?",
      preview: "Tap to choose",
      input: {
        type: "select",
        columns: 2,
        autoAdvance: true,
        options: [
          {
            value: "sliding",
            label: "Sliding Gate",
            icon: "‚óÄ‚ñ∂",
            description: "Slides along the fence line. Best for driveways with limited swing space. Most popular in Perth.",
            priceHint: "From $2,800",
            tags: [{ text: "Most Popular", highlight: true }]
          },
          {
            value: "single_swing",
            label: "Single Swing",
            icon: "üö™",
            description: "Classic hinged gate. Needs clearance to swing open. Great for pedestrian or narrow driveways.",
            priceHint: "From $2,200",
            tags: [{ text: "Simple install" }]
          },
          {
            value: "double_swing",
            label: "Double Swing",
            icon: "üìñ",
            description: "Two gates swinging from each side. Grand look for wide driveways. Needs room to swing.",
            priceHint: "From $3,200",
            tags: [{ text: "Wide driveways" }]
          },
          {
            value: "pedestrian",
            label: "Pedestrian Gate",
            icon: "üö∂",
            description: "Side gate or garden gate for foot traffic only. Usually matches your fencing style.",
            priceHint: "From $1,200",
            tags: [{ text: "Budget friendly" }]
          },
        ]
      },
      hints: [
        {
          tabLabel: "Compare",
          type: "comparison_table",
          columns: ["Feature", "Sliding", "Single Swing", "Double Swing"],
          rows: [
            ["Best for", "Driveways", "Narrow entry", "Wide entry"],
            ["Space needed", "Along fence", "Swing arc", "Double arc"],
            ["Can automate?", "Yes", "Yes", "Yes"],
            ["Install complexity", "Medium", "Easy", "Medium"],
            ["Cost range", "$2,800+", "$2,200+", "$3,200+"],
          ],
          cellStyles: {
            "Easy": "positive", "Yes": "positive",
          }
        },
        {
          tabLabel: "Tips",
          type: "tips",
          tips: [
            {
              icon: "üìê",
              title: "Measure your opening",
              text: "For a sliding gate, you'll need clear fence line equal to the opening width for the gate to slide into. Check for downpipes, taps, or garden beds in the way."
            },
            {
              icon: "‚ö°",
              title: "Planning to automate?",
              text: "If you think you'll want a motor later, mention it now. It's cheaper to prep the install for automation from the start than to retrofit."
            },
            {
              icon: "üè†",
              title: "Strata or body corp?",
              text: "You may need written approval before installing a gate. Some strata schemes have specific colour and style requirements."
            },
          ]
        }
      ]
    },

    // ‚îÄ‚îÄ STEP 2: Style ‚îÄ‚îÄ
    {
      id: "style",
      title: "What style?",
      preview: "Choose the look",
      input: {
        type: "select",
        columns: 2,
        autoAdvance: true,
        options: [
          {
            value: "slat",
            label: "Aluminium Slat",
            icon: "‚ñ§",
            description: "Horizontal slats. Clean modern look with privacy. The most popular style in Perth.",
            priceHint: "Standard",
            tags: [{ text: "Popular", highlight: true }]
          },
          {
            value: "picket",
            label: "Picket",
            icon: "‚ñ•",
            description: "Classic vertical pickets. Traditional look. Partial visibility through gaps.",
            priceHint: "+$200",
            tags: [{ text: "Traditional" }]
          },
          {
            value: "batten",
            label: "Batten",
            icon: "‚ñ¶",
            description: "Vertical battens with small gaps. Modern twist on the classic look. Good privacy.",
            priceHint: "+$300",
            tags: [{ text: "Modern" }]
          },
          {
            value: "blade",
            label: "Vertical Blade",
            icon: "‚ñÆ",
            description: "Angled vertical blades. Premium look with adjustable privacy and airflow.",
            priceHint: "+$400",
            tags: [{ text: "Premium" }]
          },
        ]
      },
      hints: [
        {
          tabLabel: "Style Guide",
          type: "mixed",
          content: [
            {
              type: "paragraph",
              text: "Your gate style should match your fence and home. Most Perth homes go with aluminium slat for the clean, modern look ‚Äî but heritage homes suit picket or batten."
            },
            {
              type: "key_point",
              label: "Matching your fence",
              text: "If you already have Colorbond fencing, an aluminium slat gate in the same colour is the most seamless option. Ask about matching profiles."
            },
            {
              type: "tip",
              icon: "üí®",
              title: "Wind considerations",
              text: "In exposed areas (hills, coastal), gates with some airflow (slat, blade, picket) handle wind better than solid panels. A solid gate acts like a sail."
            }
          ]
        }
      ]
    },

    // ‚îÄ‚îÄ STEP 3: Colour ‚îÄ‚îÄ
    {
      id: "colour",
      title: "What colour?",
      preview: "Colorbond & powder coat options",
      input: {
        type: "select",
        columns: 3,
        autoAdvance: true,
        options: [
          { value: "monument", label: "Monument", icon: "‚¨õ", priceHint: "Standard", tags: [{ text: "#1 in Perth", highlight: true }] },
          { value: "woodland_grey", label: "Woodland Grey", icon: "üü´", priceHint: "Standard" },
          { value: "basalt", label: "Basalt", icon: "‚¨õ", priceHint: "Standard" },
          { value: "surfmist", label: "Surfmist", icon: "‚¨ú", priceHint: "Standard" },
          { value: "night_sky", label: "Night Sky", icon: "üåë", priceHint: "Standard" },
          { value: "pale_eucalypt", label: "Pale Eucalypt", icon: "üü©", priceHint: "Standard" },
          { value: "paperbark", label: "Paperbark", icon: "üü®", priceHint: "Standard" },
          { value: "ironstone", label: "Ironstone", icon: "üü§", priceHint: "Standard" },
          { value: "custom_ral", label: "Custom RAL", icon: "üé®", priceHint: "+$300", tags: [{ text: "Custom" }] },
        ]
      },
      hints: [
        {
          tabLabel: "Colour Tips",
          type: "mixed",
          content: [
            {
              type: "paragraph",
              text: "Monument and Woodland Grey are the top sellers in Perth. They suit most homes and match standard Colorbond fencing."
            },
            {
              type: "key_point",
              label: "Match your neighbours",
              text: "Check what colour your neighbours' fences and gates are. A matching or complementary colour looks sharp from the street."
            },
            {
              type: "tip",
              icon: "üé®",
              title: "Custom RAL colour",
              text: "If you need an exact colour match (e.g. to a specific render or cladding), we can powder coat to any RAL colour. Adds about $300 and a few extra days."
            }
          ]
        }
      ]
    },

    // ‚îÄ‚îÄ STEP 4: Height ‚îÄ‚îÄ
    {
      id: "height",
      title: "How high?",
      preview: "Standard is 1800mm",
      input: {
        type: "select",
        columns: 2,
        autoAdvance: true,
        options: [
          { value: "1200", label: "1200mm", icon: "üìè", description: "Low profile. Good for front fences or where height isn't a priority." },
          { value: "1500", label: "1500mm", icon: "üìè", description: "Mid height. Common for front property boundaries." },
          { value: "1800", label: "1800mm", icon: "üìè", description: "Standard height. Privacy without needing council approval.", tags: [{ text: "Standard", highlight: true }] },
          { value: "2100", label: "2100mm+", icon: "üìè", description: "Extra tall. May need council approval on boundary. More materials = higher cost." },
        ]
      },
      hints: [
        {
          tabLabel: "Height Guide",
          type: "mixed",
          content: [
            {
              type: "key_point",
              label: "Standard residential",
              text: "1800mm is the standard boundary height in Perth. Your gate should match your fence height for a clean look."
            },
            {
              type: "tip",
              icon: "üìã",
              title: "Over 1800mm?",
              text: "Gates over 1800mm on a boundary may need council approval depending on your local government area. Check with your council first."
            }
          ]
        }
      ]
    },

    // ‚îÄ‚îÄ STEP 5: Width ‚îÄ‚îÄ
    {
      id: "width",
      title: "Opening width?",
      preview: "Measure the gap",
      input: {
        type: "select",
        columns: 2,
        autoAdvance: true,
        options: [
          { value: "3m", label: "Up to 3m", icon: "‚ÜîÔ∏è", description: "Single car or pedestrian. Tight but works for most." },
          { value: "4m", label: "3m ‚Äì 4m", icon: "‚ÜîÔ∏è", description: "Comfortable single car. Most common driveway width.", tags: [{ text: "Most common", highlight: true }] },
          { value: "5m", label: "4m ‚Äì 5m", icon: "‚ÜîÔ∏è", description: "Wide single or tight double. Room for a boat or trailer." },
          { value: "6m", label: "5m ‚Äì 6m+", icon: "‚ÜîÔ∏è", description: "Double driveway or wide access. May need heavier-duty gate and track." },
        ]
      },
      hints: [
        {
          tabLabel: "Measuring",
          type: "mixed",
          content: [
            {
              type: "paragraph",
              text: "Measure the gap between your pillars, posts, or where the gate will sit. If you're not sure, measure your driveway at the property boundary."
            },
            {
              type: "key_point",
              label: "Sliding gate clearance",
              text: "A sliding gate needs clear fence line (no bins, taps, garden beds) on one side equal to the opening width. A 4m opening needs 4m of clear fence."
            }
          ]
        }
      ]
    },

    // ‚îÄ‚îÄ STEP 6: Slope ‚îÄ‚îÄ
    {
      id: "slope",
      title: "Is your driveway on a slope?",
      preview: "Affects the install",
      input: {
        type: "select",
        columns: 2,
        autoAdvance: true,
        options: [
          { value: "flat", label: "Flat", icon: "‚ûñ", description: "Level ground. Standard install." },
          { value: "slight", label: "Slight Slope", icon: "üìê", description: "Gentle incline. Minor adjustments needed." },
          { value: "steep", label: "Steep Slope", icon: "‚õ∞Ô∏è", description: "Noticeable hill. Custom track/frame work required." },
          { value: "unsure", label: "Not Sure", icon: "‚ùì", description: "No worries ‚Äî we'll check on the site visit." },
        ]
      },
      hints: [
        {
          tabLabel: "Slope Info",
          type: "mixed",
          content: [
            {
              type: "paragraph",
              text: "Slopes affect how the gate is built and installed. Sliding gates on a slope need a custom track that follows the ground angle. Swing gates may need a curved bottom rail."
            },
            {
              type: "tip",
              icon: "üí∞",
              title: "Cost impact",
              text: "A slight slope adds around 10% to the install cost. A steep slope can add 25% due to custom fabrication and extra labour. Don't stress if you're not sure ‚Äî 'Not Sure' is fine, we'll assess on site."
            }
          ]
        }
      ]
    },

    // ‚îÄ‚îÄ STEP 7: Job Type ‚îÄ‚îÄ
    {
      id: "job_type",
      title: "What kind of job?",
      preview: "New or existing?",
      input: {
        type: "select",
        columns: 2,
        autoAdvance: true,
        options: [
          { value: "new", label: "New Install", icon: "üÜï", description: "Brand new gate where there isn't one. Full supply and install." },
          { value: "replace", label: "Replace Gate", icon: "üîÑ", description: "Remove old gate, install new. Includes removal of existing gate.", priceHint: "+$500" },
          { value: "motor_only", label: "Replace Motor", icon: "‚öôÔ∏è", description: "Existing gate is fine, just need a new motor/automation.", priceHint: "Motor only" },
          { value: "automate", label: "Automate Existing", icon: "ü§ñ", description: "Gate works manually but you want to add a motor and remotes.", priceHint: "Add motor" },
        ]
      },
      hints: [
        {
          tabLabel: "Job Info",
          type: "mixed",
          content: [
            {
              type: "key_point",
              label: "Replacing an old gate?",
              text: "We'll remove your old gate as part of the job. If it's a heavy steel gate or has concrete footings, removal may take a bit longer but it's included in the replace price."
            },
            {
              type: "tip",
              icon: "ü§ñ",
              title: "Just need automation?",
              text: "If your existing gate is in good condition and just needs a motor, that's a much simpler (and cheaper) job. We'll check your gate is suitable during the site visit."
            }
          ]
        }
      ]
    },

    // ‚îÄ‚îÄ STEP 8: Property Type ‚îÄ‚îÄ
    {
      id: "property_type",
      title: "Property type?",
      preview: "Helps with requirements",
      input: {
        type: "select",
        columns: 1,
        autoAdvance: true,
        options: [
          { value: "residential", label: "Residential", icon: "üè†", description: "Standard home. Most straightforward install." },
          { value: "commercial", label: "Commercial", icon: "üè¢", description: "Business or industrial. May need heavier-duty gate and compliance.", priceHint: "+20%" },
          { value: "strata", label: "Strata / Body Corp", icon: "üèòÔ∏è", description: "Shared property. May need approval and specific colour/style requirements.", priceHint: "+15%" },
        ]
      },
      hints: [
        {
          tabLabel: "Property Info",
          type: "mixed",
          content: [
            {
              type: "key_point",
              label: "Commercial properties",
              text: "Commercial gates often need heavier-duty motors, safety beams, and signage. This adds to the cost but is usually required by WA regulations."
            },
            {
              type: "tip",
              icon: "üèòÔ∏è",
              title: "Strata approval",
              text: "Get written approval from your body corp BEFORE ordering. They may specify the exact colour (usually the estate's standard colour) and style. We can provide specs for your application."
            }
          ]
        }
      ]
    },

    // ‚îÄ‚îÄ STEP 9: Timeframe ‚îÄ‚îÄ
    {
      id: "timeframe",
      title: "When do you need it?",
      preview: "Helps us plan",
      input: {
        type: "select",
        columns: 2,
        autoAdvance: true,
        options: [
          { value: "asap", label: "ASAP", icon: "‚ö°", description: "Within 2 weeks if possible.", tags: [{ text: "Priority" , highlight: true}] },
          { value: "month", label: "This Month", icon: "üìÖ", description: "Flexible on the exact date." },
          { value: "planning", label: "Still Planning", icon: "üìã", description: "Just getting an idea of cost." },
          { value: "quotes", label: "Getting Quotes", icon: "üîç", description: "Comparing a few options." },
        ]
      },
      hints: [
        {
          tabLabel: "Timing",
          type: "mixed",
          content: [
            {
              type: "paragraph",
              text: "Most gate installs in Perth take 2‚Äì4 weeks from order to completion. Custom colours or unusual sizes may add a week or two for fabrication."
            },
            {
              type: "tip",
              icon: "‚è≥",
              title: "Peak season",
              text: "Spring and early summer (Sep‚ÄìDec) are the busiest times for gate installs in Perth. If you're flexible on timing, autumn and winter often have shorter wait times."
            }
          ]
        }
      ]
    },

    // ‚îÄ‚îÄ STEP 10: Extras ‚îÄ‚îÄ
    {
      id: "extras",
      title: "Any extras?",
      preview: "Motors, intercoms, etc",
      input: {
        type: "toggle_group",
        toggles: [
          { id: "motor", label: "Gate Motor", icon: "‚ö°", costHint: "Adds ~$800" },
          { id: "intercom", label: "Intercom System", icon: "üìû", costHint: "Adds ~$600" },
          { id: "keypad", label: "Keypad Access", icon: "üî¢", costHint: "Adds ~$350" },
          { id: "remotes", label: "Extra Remotes (√ó2)", icon: "üì°", costHint: "Adds ~$120" },
          { id: "safety_beams", label: "Safety Beams", icon: "üî¥", costHint: "Adds ~$250" },
          { id: "ped_gate", label: "Matching Pedestrian Gate", icon: "üö∂", costHint: "Adds ~$1,200" },
        ]
      },
      hints: [
        {
          tabLabel: "Extras Guide",
          type: "mixed",
          content: [
            {
              type: "key_point",
              label: "Gate motor",
              text: "If you're getting a sliding or swing gate, automation is the most popular add-on. Open and close from your car with a remote ‚Äî essential for Perth's rainy winter mornings."
            },
            {
              type: "key_point",
              label: "Safety beams",
              text: "Infrared beams detect obstacles in the gate's path. Recommended for any automated gate, especially with kids or pets. Some councils require them."
            },
            {
              type: "tip",
              icon: "üìû",
              title: "Intercom vs keypad",
              text: "An intercom lets you see/talk to visitors and buzz them in. A keypad just lets people with the code open the gate themselves. Many people get both."
            }
          ]
        }
      ]
    },
  ],

  estimate: {
    title: "Your ballpark estimate",
    preview: "Based on your selections",
    note: "Supply & install ‚Ä¢ incl. GST ‚Ä¢ Perth metro",
    hints: [
      {
        type: "key_point",
        label: "How accurate is this?",
        text: "This is a rough guide based on average Perth pricing in 2025. Your actual quote depends on site access, soil conditions, exact measurements, and specific product choices. We'll confirm everything on the free site visit."
      },
      {
        type: "tip",
        icon: "üìû",
        title: "Want to talk it through?",
        text: "If you'd rather chat on the phone, give Daryl a call. He can walk you through options and give you a quick verbal estimate."
      }
    ]
  },

  // ‚îÄ‚îÄ PRICING LOGIC ‚îÄ‚îÄ
  pricing: {
    unit: "per_gate",
    unitLabel: "per gate",
    basePriceStep: "gate_type",
    basePrices: {
      sliding:       { low: 2380, high: 3220 },
      single_swing:  { low: 1870, high: 2530 },
      double_swing:  { low: 2720, high: 3680 },
      pedestrian:    { low: 1020, high: 1380 },
    },

    // No quantity slider for gates ‚Äî it's per unit
    quantitySource: null,

    // Adjustments added to base BEFORE multipliers
    preAdjustments: [
      {
        source: "style",
        type: "additive",
        values: { slat: 0, picket: 200, batten: 300, blade: 400 }
      },
      {
        source: "colour",
        type: "additive",
        values: { custom_ral: 300, _default: 0 }
      }
    ],

    // Multipliers applied to (base + preAdjustments)
    multipliers: [
      {
        source: "height",
        type: "select_map",
        values: { "1200": 0.8, "1500": 0.9, "1800": 1.0, "2100": 1.2 }
      },
      {
        source: "width",
        type: "select_map",
        values: { "3m": 1.0, "4m": 1.15, "5m": 1.3, "6m": 1.5 }
      },
      {
        source: "slope",
        type: "select_map",
        values: { flat: 1.0, slight: 1.1, steep: 1.25, unsure: 1.1 }
      },
      {
        source: "property_type",
        type: "select_map",
        values: { residential: 1.0, commercial: 1.2, strata: 1.15 }
      }
    ],

    // Adjustments added AFTER multipliers
    postAdjustments: [
      {
        source: "job_type",
        type: "additive",
        values: { new: 0, replace: 500, motor_only: -1800, automate: -800 }
      }
    ],

    // Toggle extras ‚Äî fixed amounts
    extras: [
      { id: "motor", type: "fixed", low: 800, high: 800, breakdownLabel: "Gate Motor" },
      { id: "intercom", type: "fixed", low: 600, high: 600, breakdownLabel: "Intercom System" },
      { id: "keypad", type: "fixed", low: 350, high: 350, breakdownLabel: "Keypad Access" },
      { id: "remotes", type: "fixed", low: 120, high: 120, breakdownLabel: "Extra Remotes (√ó2)" },
      { id: "safety_beams", type: "fixed", low: 250, high: 250, breakdownLabel: "Safety Beams" },
      { id: "ped_gate", type: "fixed", low: 1200, high: 1200, breakdownLabel: "Matching Pedestrian Gate" },
    ],

    showBreakdown: true,
    roundTo: 50,
    minimumPrice: 800,
  },

  leadCapture: {
    enabled: true,
    title: "Get your exact quote",
    preview: "Free site visit, no obligation",
    heading: "Almost there!",
    subheading: "Leave your details and Daryl will get back to you within 24 hours ‚Äî usually same day for urgent jobs.",
    showSummary: true,
    fields: [
      { id: "name", label: "Your name", type: "text", placeholder: "e.g. Dave Smith", required: true },
      { id: "phone", label: "Phone", type: "tel", placeholder: "e.g. 0412 345 678", required: true },
      { id: "email", label: "Email", type: "email", placeholder: "e.g. dave@email.com", required: false },
      { id: "suburb", label: "Suburb", type: "text", placeholder: "e.g. Joondalup", required: false },
      { id: "notes", label: "Anything else?", type: "textarea", placeholder: "e.g. Access issues, specific requirements, questions...", required: false },
    ],
    submitText: "üì© Send My Details",
    submitNote: "No spam. Daryl will be in touch shortly.",
    successMessage: "Thanks! Daryl will be in touch within 24 hours.",
    successSubtext: "Your estimate and details have been sent. If it's urgent, give us a call.",
    delivery: {
      method: "web3forms",
      web3formsKey: "99a11c15-5c61-4765-99c5-673adec64b16",
      notifyEmail: "responses@itabs.ai",
      emailSubject: "New Gate Enquiry ‚Äî Gateworld Perth",
    }
  },

  socialProof: {
    enabled: true,
    rating: 5.0,
    reviewCount: 48,
    badges: ["Licensed & Insured", "Perth Local", "Free Site Visits"],
  },

  footer: {
    showPoweredBy: true,
    poweredByUrl: "https://itabs.ai",
  }
};
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ENGINE v1.1 ‚Äî Generic. Do not edit per client.
     
     v1.1 changes:
     - Added preAdjustments / postAdjustments for select-based price modifiers
     - Added select_map multiplier type (multiplier from select answer, not slider)
     - quantitySource can be null for per-unit pricing (e.g. gates)
     - columns: 3 support for select grids
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<script>
if (WIDGET_CONFIG.branding.googleFontsUrl) {
  const link = document.createElement('link');
  link.rel = 'stylesheet';
  link.href = WIDGET_CONFIG.branding.googleFontsUrl;
  document.head.appendChild(link);
  const preconnect = document.createElement('link');
  preconnect.rel = 'preconnect';
  preconnect.href = 'https://fonts.googleapis.com';
  document.head.prepend(preconnect);
}
document.title = WIDGET_CONFIG.header.headline + ' | ' + WIDGET_CONFIG.business.name;
</script>

<style>
:root {
  --bg-main: #0c1117;
  --bg-card: #151c25;
  --bg-hover: #1a2332;
  --bg-dark: #0a0e14;
  --border: #222d3a;
  --brand-primary: #f59e0b;
  --brand-secondary: #d97706;
  --brand-glow: rgba(245, 158, 11, 0.15);
  --accent-green: #22c55e;
  --accent-blue: #3b82f6;
  --accent-red: #ef4444;
  --text-primary: #e8ecf1;
  --text-secondary: #8896a7;
  --text-muted: #5a6a7d;
  --font-main: 'Plus Jakarta Sans', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --radius: 14px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: var(--font-main);
  background: var(--bg-main);
  color: var(--text-primary);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}
.container { max-width: 520px; margin: 0 auto; padding: 20px 16px 40px; }

/* Header */
.header { text-align: center; padding: 30px 0 25px; }
.header-icon { font-size: 2.5rem; margin-bottom: 12px; }
.header h1 {
  font-size: 1.6rem; font-weight: 800; margin-bottom: 6px;
  background: linear-gradient(135deg, var(--brand-primary), #fbbf24);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.header p { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.5; }
.header .badge-line {
  display: inline-block; background: var(--bg-card); border: 1px solid var(--border);
  padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; color: var(--text-muted); margin-top: 12px;
}

/* Progress */
.progress-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.75rem; color: var(--text-muted); }
.progress-bar { background: var(--bg-card); border-radius: 10px; height: 6px; margin-bottom: 25px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary)); border-radius: 10px; width: 0%; transition: width 0.5s ease; }

/* Sections */
.itab-section { background: var(--bg-card); border-radius: var(--radius); margin-bottom: 14px; overflow: hidden; border: 1px solid var(--border); transition: all 0.3s ease; scroll-margin-top: 16px; }
.itab-section:hover { border-color: rgba(245, 158, 11, 0.3); }
.itab-section.completed { border-color: var(--accent-green); }
.itab-section.completed .itab-number { background: var(--accent-green); }
.itab-header { display: flex; align-items: center; justify-content: space-between; padding: 18px 16px; cursor: pointer; transition: background 0.2s; }
.itab-header:hover { background: var(--bg-hover); }
.itab-title { display: flex; align-items: center; gap: 12px; }
.itab-number { width: 34px; height: 34px; background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; color: #000; flex-shrink: 0; }
.itab-name { font-size: 1rem; font-weight: 600; }
.itab-preview { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
.itab-preview .selected { color: var(--accent-green); font-weight: 500; }
.i-button { width: 32px; height: 32px; background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); border: none; border-radius: 8px; color: #000; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s; font-family: serif; font-style: italic; flex-shrink: 0; }
.i-button:hover { transform: scale(1.1); box-shadow: 0 0 20px var(--brand-glow); }
.i-button.active { background: var(--accent-green); color: white; }
.itab-content { display: none; padding: 0 16px 18px; border-top: 1px solid var(--border); }
.itab-content.show { display: block; animation: fadeInUp 0.3s ease; }

/* Tabs */
.tabs { display: flex; gap: 6px; padding: 14px 0; border-bottom: 1px solid var(--border); margin-bottom: 14px; flex-wrap: wrap; }
.tab { padding: 7px 14px; background: var(--bg-hover); border: none; border-radius: 8px; color: var(--text-secondary); cursor: pointer; font-family: var(--font-main); font-size: 0.85rem; font-weight: 500; transition: all 0.2s; }
.tab:hover { color: var(--text-primary); }
.tab.active { background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); color: #000; font-weight: 600; }
.tab-panel { display: none; }
.tab-panel.show { display: block; }
.tab-panel h3 { color: var(--brand-primary); margin-bottom: 10px; font-size: 1rem; }
.tab-panel p { color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6; font-size: 0.9rem; }

/* Select options */
.option-grid { display: grid; gap: 10px; margin: 10px 0; }
.option-grid.cols-2 { grid-template-columns: 1fr 1fr; }
.option-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
.option-card { background: var(--bg-dark); border: 2px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s; }
.option-card:hover { border-color: var(--brand-primary); background: var(--bg-hover); }
.option-card.selected { border-color: var(--accent-green); background: rgba(34, 197, 94, 0.05); }
.option-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.option-name { font-weight: 700; font-size: 1rem; }
.option-price { font-family: var(--font-mono); font-size: 0.85rem; color: var(--brand-primary); font-weight: 500; }
.option-desc { color: var(--text-muted); font-size: 0.82rem; line-height: 1.5; }
.option-check { display: none; color: var(--accent-green); font-weight: 700; font-size: 0.85rem; margin-top: 6px; }
.option-card.selected .option-check { display: inline; }
.option-tags { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
.option-tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; background: var(--bg-hover); color: var(--text-muted); }
.option-tag.highlight { background: rgba(245, 158, 11, 0.15); color: var(--brand-primary); }

/* Compact option for 3-col */
.cols-3 .option-card { padding: 12px 10px; text-align: center; }
.cols-3 .option-top { flex-direction: column; gap: 2px; }
.cols-3 .option-name { font-size: 0.85rem; }
.cols-3 .option-price { font-size: 0.75rem; }
.cols-3 .option-desc { display: none; }
.cols-3 .option-check { font-size: 0.75rem; }

/* Sliders */
.slider-group { margin: 16px 0; }
.slider-label { display: flex; justify-content: space-between; margin-bottom: 8px; }
.slider-label span { color: var(--text-secondary); font-size: 0.9rem; }
.slider-value { font-family: var(--font-mono); color: var(--brand-primary); font-weight: 600; }
input[type="range"] { width: 100%; -webkit-appearance: none; appearance: none; height: 8px; background: var(--bg-dark); border-radius: 4px; outline: none; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3); }
input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); border-radius: 50%; cursor: pointer; border: none; }
.slider-markers { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; }

/* Toggles */
.toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border); }
.toggle-row:last-child { border-bottom: none; }
.toggle-info .toggle-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; }
.toggle-info .toggle-cost { font-size: 0.8rem; color: var(--text-muted); }
.toggle-switch { width: 48px; height: 26px; background: var(--bg-dark); border-radius: 13px; border: 2px solid var(--border); cursor: pointer; position: relative; transition: all 0.3s; flex-shrink: 0; }
.toggle-switch.on { background: var(--accent-green); border-color: var(--accent-green); }
.toggle-knob { width: 18px; height: 18px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s; }
.toggle-switch.on .toggle-knob { left: 24px; }

/* Estimate */
.estimate-box { background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(217, 119, 6, 0.05)); border: 2px solid var(--brand-primary); border-radius: var(--radius); padding: 24px; margin: 20px 0; text-align: center; }
.est-label { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
.est-range { font-family: var(--font-mono); font-size: 2rem; font-weight: 700; color: var(--brand-primary); margin-bottom: 4px; }
.est-note { color: var(--text-muted); font-size: 0.78rem; }
.estimate-breakdown { margin-top: 16px; text-align: left; }
.breakdown-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(245, 158, 11, 0.1); font-size: 0.85rem; }
.breakdown-row:last-child { border-bottom: none; }
.breakdown-row .br-label { color: var(--text-secondary); }
.breakdown-row .br-value { font-family: var(--font-mono); color: var(--text-primary); font-weight: 500; }

/* Hints */
.key-point { background: var(--bg-dark); border-left: 4px solid var(--brand-primary); padding: 12px 16px; margin: 12px 0; border-radius: 0 8px 8px 0; }
.key-point .kp-label { color: var(--brand-primary); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.key-point p { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0; }
.tip-card { background: rgba(59, 130, 246, 0.08); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 10px; padding: 12px 14px; margin: 10px 0; font-size: 0.85rem; }
.tip-card .tip-title { font-weight: 600; color: var(--accent-blue); margin-bottom: 4px; }
.tip-card p { color: var(--text-secondary); margin-bottom: 0; font-size: 0.83rem; }
.warning-card { border: 1px solid rgba(239,68,68,0.3); background: rgba(239,68,68,0.08); border-radius: 10px; padding: 12px 14px; margin: 10px 0; font-size: 0.85rem; }
.warning-card .warning-title { font-weight: 600; color: var(--accent-red); margin-bottom: 4px; }
.warning-card p { color: var(--text-secondary); margin-bottom: 0; font-size: 0.83rem; }

/* Comparison table */
.compare-table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 0.82rem; }
.compare-table th { text-align: left; padding: 10px 8px; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
.compare-table td { padding: 10px 8px; color: var(--text-secondary); border-bottom: 1px solid var(--border); }
.compare-table td:first-child { font-weight: 600; color: var(--text-primary); }
.compare-table .positive { color: var(--accent-green); }
.compare-table .negative { color: var(--accent-red); }

/* Lead form */
.form-group { margin-bottom: 12px; text-align: left; }
.form-group label { display: block; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px; font-weight: 500; }
.form-group input, .form-group textarea { width: 100%; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: var(--font-main); font-size: 0.9rem; outline: none; transition: border-color 0.2s; }
.form-group input:focus, .form-group textarea:focus { border-color: var(--brand-primary); }
.form-group textarea { resize: vertical; min-height: 70px; }
.submit-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); border: none; border-radius: 10px; color: #000; font-family: var(--font-main); font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
.submit-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px var(--brand-glow); }
.submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
.summary-box { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 16px; font-size: 0.83rem; }
.summary-label { font-weight: 600; color: var(--brand-primary); margin-bottom: 8px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
.summary-content { color: var(--text-secondary); line-height: 1.8; }
.success-message { text-align: center; padding: 30px 20px; animation: fadeInUp 0.4s ease; }
.success-message .check-icon { font-size: 3rem; margin-bottom: 12px; }
.success-message h3 { color: var(--accent-green); margin-bottom: 8px; }
.success-message p { color: var(--text-secondary); font-size: 0.9rem; }

/* Social proof */
.social-proof { display: flex; align-items: center; justify-content: center; gap: 16px; padding: 12px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); flex-wrap: wrap; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px; }
.sp-stars { color: var(--brand-primary); letter-spacing: 1px; }
.sp-rating { color: var(--brand-primary); font-weight: 600; }
.sp-badge { background: var(--bg-hover); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; white-space: nowrap; }

/* Footer */
.powered-by { text-align: center; padding: 30px 0 10px; font-size: 0.75rem; color: var(--text-muted); }
.powered-by a { color: var(--brand-primary); text-decoration: none; font-weight: 600; }

@keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="container" id="app"></div>

<script>
const C = WIDGET_CONFIG;
const state = {
  answers: {},
  sliders: {},
  toggles: {},
  openSection: null,
  completedSections: new Set(),
};

function applyBranding() {
  const b = C.branding; const r = document.documentElement.style;
  r.setProperty('--bg-main', b.backgroundColor); r.setProperty('--bg-card', b.cardBackground);
  r.setProperty('--bg-hover', b.hoverBackground); r.setProperty('--bg-dark', b.darkBackground);
  r.setProperty('--border', b.borderColor); r.setProperty('--brand-primary', b.primaryColor);
  r.setProperty('--brand-secondary', b.secondaryColor); r.setProperty('--text-primary', b.textColor);
  r.setProperty('--text-secondary', b.mutedText); r.setProperty('--text-muted', b.dimText);
  r.setProperty('--accent-green', b.successColor); r.setProperty('--accent-red', b.errorColor);
  r.setProperty('--accent-blue', b.infoColor); r.setProperty('--font-main', b.fontFamily);
  r.setProperty('--font-mono', b.monoFont); r.setProperty('--radius', b.borderRadius);
}

function init() {
  applyBranding(); initDefaults(); render();
  setTimeout(() => toggleSection(0), 300);
}

function initDefaults() {
  C.steps.forEach(step => {
    if (step.input.type === 'slider_group') {
      step.input.sliders.forEach(s => {
        const raw = s.default;
        if (s.valueMap) {
          const mapped = s.valueMap.find(v => v.value === raw);
          state.sliders[s.id] = { raw, numeric: mapped ? mapped.numericValue : raw, label: mapped ? mapped.label : raw + (s.unit || '') };
        } else {
          state.sliders[s.id] = { raw, numeric: raw, label: raw + (s.unit || '') };
        }
      });
    }
    if (step.input.type === 'toggle_group') {
      step.input.toggles.forEach(t => { state.toggles[t.id] = false; });
    }
  });
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function render() {
  const app = document.getElementById('app');
  let html = renderHeader();
  if (C.socialProof && C.socialProof.enabled) html += renderSocialProof();
  const totalSections = C.steps.length + (C.estimate ? 1 : 0) + (C.leadCapture && C.leadCapture.enabled ? 1 : 0);
  html += `<div class="progress-label"><span>Your quote</span><span id="progressText">0 of ${totalSections}</span></div><div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>`;
  C.steps.forEach((step, i) => { html += renderSection(step, i); });
  if (C.estimate) html += renderEstimateSection(C.steps.length);
  if (C.leadCapture && C.leadCapture.enabled) html += renderLeadSection(C.steps.length + (C.estimate ? 1 : 0));
  if (C.footer && C.footer.showPoweredBy) html += `<div class="powered-by">Powered by <a href="${C.footer.poweredByUrl}" target="_blank">iTabs</a> ¬∑ Interactive tools that convert</div>`;
  app.innerHTML = html;
}

function renderHeader() {
  const h = C.header;
  return `<div class="header"><div class="header-icon">${h.icon}</div><h1>${h.headline}</h1><p>${h.subtitle}</p>${h.badge ? `<span class="badge-line">${h.badge}</span>` : ''}</div>`;
}

function renderSocialProof() {
  const sp = C.socialProof;
  return `<div class="social-proof"><span class="sp-stars">${'‚òÖ'.repeat(Math.floor(sp.rating))}</span><span class="sp-rating">${sp.rating} from ${sp.reviewCount} reviews</span>${sp.badges.map(b => `<span class="sp-badge">${b}</span>`).join('')}</div>`;
}

function renderSection(step, index) {
  const sectionId = `section-${index}`;
  const completed = state.completedSections.has(sectionId) ? ' completed' : '';
  const isOpen = state.openSection === sectionId;
  const preview = getPreview(step);
  const inputTabLabel = step.input.type === 'toggle_group' ? 'Add Extras' : step.input.type === 'slider_group' ? 'Set Size' : 'Choose';
  const hintTabs = step.hints || [];

  let contentHtml = '';
  if (hintTabs.length > 0) {
    contentHtml += `<div class="tabs"><button class="tab active" onclick="showTab(this, '${sectionId}-input')">${inputTabLabel}</button>`;
    hintTabs.forEach((h, hi) => { contentHtml += `<button class="tab" onclick="showTab(this, '${sectionId}-hint-${hi}')">${h.tabLabel}</button>`; });
    contentHtml += `</div>`;
  }
  contentHtml += `<div class="tab-panel show" id="${sectionId}-input">${renderInput(step, sectionId)}`;
  if (step.warnings) step.warnings.forEach(w => {
    contentHtml += `<div class="warning-card" id="${sectionId}-warning-${w.condition.replace(/[^a-z0-9]/gi,'')}" style="display:none;"><div class="warning-title">${w.icon} ${w.title}</div><p>${w.text}</p></div>`;
  });
  contentHtml += `</div>`;
  hintTabs.forEach((hint, hi) => { contentHtml += `<div class="tab-panel" id="${sectionId}-hint-${hi}">${renderHint(hint)}</div>`; });

  return `<div class="itab-section${completed}" id="${sectionId}"><div class="itab-header" onclick="toggleSection(${index})"><div class="itab-title"><span class="itab-number">${index + 1}</span><div><div class="itab-name">${step.title}</div><div class="itab-preview" id="${sectionId}-preview">${preview}</div></div></div><button class="i-button" id="${sectionId}-btn">i</button></div><div class="itab-content${isOpen ? ' show' : ''}" id="${sectionId}-content">${contentHtml}</div></div>`;
}

function renderEstimateSection(index) {
  const sectionId = `section-${index}`;
  const est = C.estimate;
  const isOpen = state.openSection === sectionId;
  const completed = state.completedSections.has(sectionId) ? ' completed' : '';
  let hintsHtml = '';
  if (est.hints) est.hints.forEach(h => { hintsHtml += renderHintItem(h); });
  return `<div class="itab-section${completed}" id="${sectionId}"><div class="itab-header" onclick="toggleSection(${index})"><div class="itab-title"><span class="itab-number">${index + 1}</span><div><div class="itab-name">${est.title}</div><div class="itab-preview" id="${sectionId}-preview">${est.preview}</div></div></div><button class="i-button" id="${sectionId}-btn">i</button></div><div class="itab-content${isOpen ? ' show' : ''}" id="${sectionId}-content"><div class="estimate-box"><div class="est-label">Estimated range</div><div class="est-range" id="estRange">‚Äî</div><div class="est-note" id="estNote">Complete the sections above to see your estimate</div><div class="estimate-breakdown" id="estBreakdown"></div></div>${hintsHtml}</div></div>`;
}

function renderLeadSection(index) {
  const sectionId = `section-${index}`;
  const lc = C.leadCapture;
  const isOpen = state.openSection === sectionId;
  const completed = state.completedSections.has(sectionId) ? ' completed' : '';
  let fieldsHtml = '';
  lc.fields.forEach(f => {
    const req = f.required ? ' *' : '';
    fieldsHtml += f.type === 'textarea'
      ? `<div class="form-group"><label>${f.label}${req}</label><textarea id="form-${f.id}" placeholder="${f.placeholder}"></textarea></div>`
      : `<div class="form-group"><label>${f.label}${req}</label><input type="${f.type}" id="form-${f.id}" placeholder="${f.placeholder}"></div>`;
  });
  return `<div class="itab-section${completed}" id="${sectionId}"><div class="itab-header" onclick="toggleSection(${index})"><div class="itab-title"><span class="itab-number">${index + 1}</span><div><div class="itab-name">${lc.title}</div><div class="itab-preview" id="${sectionId}-preview">${lc.preview}</div></div></div><button class="i-button" id="${sectionId}-btn">i</button></div><div class="itab-content${isOpen ? ' show' : ''}" id="${sectionId}-content"><div id="leadFormContainer"><p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">${lc.subheading}</p>${lc.showSummary ? `<div class="summary-box"><div class="summary-label">Your specs</div><div class="summary-content" id="quoteSummary">Select your options above first</div></div>` : ''}${fieldsHtml}<button class="submit-btn" id="submitBtn" onclick="submitLead()">${lc.submitText}</button>${lc.submitNote ? `<div style="text-align:center;margin-top:12px;font-size:0.75rem;color:var(--text-muted)">${lc.submitNote}</div>` : ''}</div><div class="success-message" id="successMsg" style="display:none;"><div class="check-icon">‚úÖ</div><h3>${lc.successMessage}</h3><p>${lc.successSubtext}</p></div></div></div>`;
}

// ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ
function renderInput(step, sectionId) {
  const input = step.input;
  switch (input.type) {
    case 'select': return renderSelect(step, sectionId, input);
    case 'multi_select': return renderMultiSelect(step, sectionId, input);
    case 'slider_group': return renderSliders(step, sectionId, input);
    case 'toggle_group': return renderToggles(step, sectionId, input);
    default: return '';
  }
}

function renderSelect(step, sectionId, input) {
  const cols = input.columns || 1;
  const colsClass = cols > 1 ? ` cols-${cols}` : '';
  let html = `<div class="option-grid${colsClass}">`;
  input.options.forEach(opt => {
    const selected = state.answers[step.id] === opt.value ? ' selected' : '';
    const tags = opt.tags ? opt.tags.map(t => `<span class="option-tag${t.highlight ? ' highlight' : ''}">${t.text}</span>`).join('') : '';
    html += `<div class="option-card${selected}" onclick="selectOption('${step.id}','${opt.value}',${C.steps.indexOf(step)},${input.autoAdvance || false})"><div class="option-top"><span class="option-name">${opt.icon} ${opt.label}</span>${opt.priceHint ? `<span class="option-price">${opt.priceHint}</span>` : ''}</div>${opt.description ? `<div class="option-desc">${opt.description}</div>` : ''}${tags ? `<div class="option-tags">${tags}</div>` : ''}<span class="option-check">‚úì Selected</span></div>`;
  });
  return html + '</div>';
}

function renderMultiSelect(step, sectionId, input) {
  if (!state.answers[step.id]) state.answers[step.id] = [];
  const cols = input.columns || 1;
  const colsClass = cols > 1 ? ` cols-${cols}` : '';
  let html = `<div class="option-grid${colsClass}">`;
  input.options.forEach(opt => {
    const selected = state.answers[step.id].includes(opt.value) ? ' selected' : '';
    html += `<div class="option-card${selected}" onclick="toggleMultiOption('${step.id}','${opt.value}',this)"><div class="option-top"><span class="option-name">${opt.icon} ${opt.label}</span>${opt.priceHint ? `<span class="option-price">${opt.priceHint}</span>` : ''}</div>${opt.description ? `<div class="option-desc">${opt.description}</div>` : ''}<span class="option-check">‚úì Selected</span></div>`;
  });
  html += '</div>';
  if (input.optional) html += `<button class="tab" style="margin-top:10px;width:100%;text-align:center;" onclick="skipStep(${C.steps.indexOf(step)})">Skip ‚Äî none needed</button>`;
  return html;
}

function renderSliders(step, sectionId, input) {
  let html = '';
  input.sliders.forEach(s => {
    const current = state.sliders[s.id];
    const displayValue = current ? current.label : s.default + (s.unit || '');
    html += `<div class="slider-group"><div class="slider-label"><span>${s.label}</span><span class="slider-value" id="slider-val-${s.id}">${displayValue}</span></div><input type="range" id="slider-${s.id}" min="${s.min}" max="${s.max}" value="${s.default}" step="${s.step}" oninput="updateSlider('${s.id}','${step.id}',${C.steps.indexOf(step)},this.value)">${s.markers ? `<div class="slider-markers">${s.markers.map(m => `<span>${m}</span>`).join('')}</div>` : ''}</div>`;
  });
  return html;
}

function renderToggles(step, sectionId, input) {
  return input.toggles.map(t => {
    const isOn = state.toggles[t.id] ? ' on' : '';
    return `<div class="toggle-row"><div class="toggle-info"><div class="toggle-name">${t.icon} ${t.label}</div><div class="toggle-cost">${t.costHint}</div></div><div class="toggle-switch${isOn}" id="toggle-${t.id}" onclick="toggleExtra('${t.id}','${step.id}',${C.steps.indexOf(step)})"><div class="toggle-knob"></div></div></div>`;
  }).join('');
}

// ‚îÄ‚îÄ HINTS ‚îÄ‚îÄ
function renderHint(hint) {
  switch (hint.type) {
    case 'comparison_table': return renderComparisonTable(hint);
    case 'tips': return hint.tips.map(t => `<div class="tip-card"><div class="tip-title">${t.icon} ${t.title}</div><p>${t.text}</p></div>`).join('');
    case 'mixed': return hint.content.map(item => renderHintItem(item)).join('');
    case 'custom_html': return hint.content;
    default: return '';
  }
}

function renderComparisonTable(hint) {
  let html = '<table class="compare-table"><thead><tr>';
  hint.columns.forEach(c => { html += `<th>${c}</th>`; });
  html += '</tr></thead><tbody>';
  hint.rows.forEach(row => {
    html += '<tr>';
    row.forEach(cell => {
      const style = hint.cellStyles && hint.cellStyles[cell];
      html += `<td${style ? ` class="${style}"` : ''}>${cell}</td>`;
    });
    html += '</tr>';
  });
  return html + '</tbody></table>';
}

function renderHintItem(item) {
  switch (item.type) {
    case 'paragraph': return `<p style="color:var(--text-secondary);font-size:0.9rem;line-height:1.6;margin-bottom:12px;">${item.text}</p>`;
    case 'key_point': return `<div class="key-point"><div class="kp-label">${item.label}</div><p>${item.text}</p></div>`;
    case 'tip': return `<div class="tip-card"><div class="tip-title">${item.icon} ${item.title}</div><p>${item.text}</p></div>`;
    default: return '';
  }
}

// ‚îÄ‚îÄ INTERACTIONS ‚îÄ‚îÄ
function toggleSection(index) {
  const sectionId = `section-${index}`;
  const content = document.getElementById(sectionId + '-content');
  const btn = document.getElementById(sectionId + '-btn');
  const isOpen = content && content.classList.contains('show');
  document.querySelectorAll('.itab-content').forEach(c => c.classList.remove('show'));
  document.querySelectorAll('.i-button').forEach(b => b.classList.remove('active'));
  if (!isOpen && content) {
    content.classList.add('show');
    if (btn) btn.classList.add('active');
    state.openSection = sectionId;
    state.completedSections.add(sectionId);
    updateProgress();
    setTimeout(() => { document.getElementById(sectionId).scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
  } else {
    state.openSection = null;
  }
}

function showTab(btn, panelId) {
  const container = btn.closest('.itab-content');
  container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  container.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('show'));
  btn.classList.add('active');
  document.getElementById(panelId).classList.add('show');
}

function selectOption(stepId, value, stepIndex, autoAdvance) {
  state.answers[stepId] = value;
  const sectionId = `section-${stepIndex}`;
  const section = document.getElementById(sectionId);
  const step = C.steps[stepIndex];
  const cards = section.querySelectorAll(`#${sectionId}-input .option-card`);
  step.input.options.forEach((opt, i) => {
    if (cards[i]) cards[i].classList.toggle('selected', opt.value === value);
  });
  section.classList.add('completed');
  state.completedSections.add(sectionId);
  const opt = step.input.options.find(o => o.value === value);
  document.getElementById(sectionId + '-preview').innerHTML = `<span class="selected">‚úì ${opt ? opt.label : value}</span>`;
  updateEstimate(); updateQuoteSummary(); updateProgress(); checkWarnings();
  if (autoAdvance) setTimeout(() => toggleSection(stepIndex + 1), 400);
}

function toggleMultiOption(stepId, value, el) {
  if (!state.answers[stepId]) state.answers[stepId] = [];
  const idx = state.answers[stepId].indexOf(value);
  if (idx > -1) { state.answers[stepId].splice(idx, 1); el.classList.remove('selected'); }
  else { state.answers[stepId].push(value); el.classList.add('selected'); }
  updateEstimate(); updateQuoteSummary();
}

function updateSlider(sliderId, stepId, stepIndex, rawValue) {
  const step = C.steps[stepIndex];
  const sliderConfig = step.input.sliders.find(s => s.id === sliderId);
  const raw = parseFloat(rawValue);
  if (sliderConfig.valueMap) {
    const mapped = sliderConfig.valueMap.find(v => v.value === raw);
    state.sliders[sliderId] = { raw, numeric: mapped ? mapped.numericValue : raw, label: mapped ? mapped.label : raw + (sliderConfig.unit || '') };
  } else {
    state.sliders[sliderId] = { raw, numeric: raw, label: raw + (sliderConfig.unit || '') };
  }
  document.getElementById(`slider-val-${sliderId}`).textContent = state.sliders[sliderId].label;
  const sectionId = `section-${stepIndex}`;
  document.getElementById(sectionId).classList.add('completed');
  state.completedSections.add(sectionId);
  const previews = step.input.sliders.map(s => { const v = state.sliders[s.id]; return s.valueMap ? v.numeric + 'm' : v.raw + (s.unit || ''); });
  document.getElementById(sectionId + '-preview').innerHTML = `<span class="selected">‚úì ${previews.join(' √ó ')}</span>`;
  updateEstimate(); updateQuoteSummary(); updateProgress(); checkWarnings();
}

function toggleExtra(toggleId, stepId, stepIndex) {
  state.toggles[toggleId] = !state.toggles[toggleId];
  document.getElementById(`toggle-${toggleId}`).classList.toggle('on');
  const sectionId = `section-${stepIndex}`;
  const step = C.steps[stepIndex];
  const activeCount = step.input.toggles.filter(t => state.toggles[t.id]).length;
  if (activeCount > 0) {
    document.getElementById(sectionId + '-preview').innerHTML = `<span class="selected">‚úì ${activeCount} extra${activeCount > 1 ? 's' : ''} added</span>`;
    document.getElementById(sectionId).classList.add('completed');
    state.completedSections.add(sectionId);
  } else {
    document.getElementById(sectionId + '-preview').textContent = step.preview;
    document.getElementById(sectionId).classList.remove('completed');
    state.completedSections.delete(sectionId);
  }
  updateEstimate(); updateQuoteSummary(); updateProgress();
}

function skipStep(stepIndex) { toggleSection(stepIndex + 1); }

// ‚îÄ‚îÄ PRICING ENGINE v1.1 ‚îÄ‚îÄ
function getSliderNumeric(sliderId) { return state.sliders[sliderId] ? state.sliders[sliderId].numeric : 0; }

function applyAdjustments(low, high, adjustments) {
  if (!adjustments) return { low, high };
  adjustments.forEach(adj => {
    const answer = state.answers[adj.source];
    if (answer !== undefined && adj.type === 'additive') {
      const val = adj.values[answer] !== undefined ? adj.values[answer] : (adj.values._default || 0);
      low += val;
      high += val;
    }
  });
  return { low, high };
}

function calculateEstimate() {
  const p = C.pricing;
  const primaryAnswer = state.answers[p.basePriceStep];
  if (!primaryAnswer || !p.basePrices[primaryAnswer]) return null;

  const base = p.basePrices[primaryAnswer];
  let low = base.low;
  let high = base.high;

  // 1. Pre-multiplier adjustments (e.g. style +$200, colour +$300)
  const pre = applyAdjustments(low, high, p.preAdjustments);
  low = pre.low; high = pre.high;

  // 2. Multipliers (from sliders OR selects)
  if (p.multipliers) {
    p.multipliers.forEach(m => {
      let mult = 1;
      if (m.type === 'value_map' && state.sliders[m.source]) {
        const numericVal = getSliderNumeric(m.source);
        mult = m.values[numericVal] !== undefined ? m.values[numericVal] : 1;
      } else if (m.type === 'select_map' && state.answers[m.source] !== undefined) {
        mult = m.values[state.answers[m.source]] !== undefined ? m.values[state.answers[m.source]] : 1;
      }
      low *= mult;
      high *= mult;
    });
  }

  // 3. Multiply by quantity (if applicable)
  const quantity = p.quantitySource && state.sliders[p.quantitySource] ? state.sliders[p.quantitySource].numeric : 1;
  low = Math.round(low * quantity);
  high = Math.round(high * quantity);

  // 4. Post-multiplier adjustments (e.g. job_type +$500 or -$1800)
  const post = applyAdjustments(low, high, p.postAdjustments);
  low = post.low; high = post.high;

  // Build breakdown
  const breakdown = [];
  const primaryOpt = findOption(p.basePriceStep, primaryAnswer);
  let baseLine = primaryOpt ? primaryOpt.label : primaryAnswer;
  if (p.quantitySource && state.sliders[p.quantitySource]) {
    baseLine += ` (${state.sliders[p.quantitySource].raw}${getSliderUnit(p.quantitySource)})`;
  }
  breakdown.push({ label: baseLine, low, high });

  // 5. Extras
  let runningLow = low, runningHigh = high;
  if (p.extras) {
    p.extras.forEach(extra => {
      if (!state.toggles[extra.id]) return;
      let extLow = 0, extHigh = 0;
      switch (extra.type) {
        case 'fixed': extLow = extra.low; extHigh = extra.high; break;
        case 'per_unit': extLow = Math.round(extra.lowPerUnit * quantity); extHigh = Math.round(extra.highPerUnit * quantity); break;
        case 'percentage': extLow = Math.round(runningLow * (extra.lowPercent / 100)); extHigh = Math.round(runningHigh * (extra.highPercent / 100)); break;
      }
      runningLow += extLow; runningHigh += extHigh;
      breakdown.push({ label: extra.breakdownLabel, low: extLow, high: extHigh, prefix: extra.type === 'percentage' ? '+' : '' });
    });
  }

  // 6. Minimum & rounding
  runningLow = Math.max(runningLow, p.minimumPrice || 0);
  runningHigh = Math.max(runningHigh, p.minimumPrice || 0);
  if (p.roundTo && p.roundTo > 0) {
    runningLow = Math.round(runningLow / p.roundTo) * p.roundTo;
    runningHigh = Math.round(runningHigh / p.roundTo) * p.roundTo;
  }

  return { low: runningLow, high: runningHigh, breakdown };
}

function findOption(stepId, value) {
  const step = C.steps.find(s => s.id === stepId);
  return step && step.input.options ? step.input.options.find(o => o.value === value) : null;
}

function getSliderUnit(sliderId) {
  for (const step of C.steps) {
    if (step.input.type === 'slider_group') {
      const s = step.input.sliders.find(sl => sl.id === sliderId);
      if (s) return s.unit || '';
    }
  }
  return '';
}

function updateEstimate() {
  const est = calculateEstimate();
  const rangeEl = document.getElementById('estRange');
  const noteEl = document.getElementById('estNote');
  const breakdownEl = document.getElementById('estBreakdown');
  const estIdx = C.steps.length;
  const previewEl = document.getElementById(`section-${estIdx}-preview`);
  if (!rangeEl) return;
  if (!est) {
    rangeEl.textContent = '‚Äî';
    noteEl.textContent = 'Complete the sections above to see your estimate';
    breakdownEl.innerHTML = '';
    if (previewEl) previewEl.textContent = C.estimate.preview;
    return;
  }
  const rangeText = `$${est.low.toLocaleString()} ‚Äì $${est.high.toLocaleString()}`;
  rangeEl.textContent = rangeText;
  noteEl.textContent = C.estimate.note;
  if (C.pricing.showBreakdown && est.breakdown) {
    breakdownEl.innerHTML = est.breakdown.map(b => `<div class="breakdown-row"><span class="br-label">${b.label}</span><span class="br-value">${b.prefix || ''}$${b.low.toLocaleString()} ‚Äì $${b.high.toLocaleString()}</span></div>`).join('');
  }
  if (previewEl) previewEl.innerHTML = `<span class="selected">‚úì ${rangeText}</span>`;
}

function updateQuoteSummary() {
  const el = document.getElementById('quoteSummary');
  if (!el) return;
  let lines = [];
  C.steps.forEach(step => {
    if (step.input.type === 'select' && state.answers[step.id]) {
      const opt = findOption(step.id, state.answers[step.id]);
      lines.push(`${opt ? opt.icon : '‚Ä¢'} ${step.title}: <strong>${opt ? opt.label : state.answers[step.id]}</strong>`);
    }
    if (step.input.type === 'slider_group') {
      const vals = step.input.sliders.map(s => state.sliders[s.id] ? state.sliders[s.id].label : '').filter(Boolean);
      if (vals.length) lines.push(`üìè ${step.title}: <strong>${vals.join(' √ó ')}</strong>`);
    }
    if (step.input.type === 'toggle_group') {
      const active = step.input.toggles.filter(t => state.toggles[t.id]);
      if (active.length) lines.push(`‚ûï Extras: ${active.map(t => t.icon + ' ' + t.label).join(', ')}`);
    }
  });
  const est = calculateEstimate();
  if (est) lines.push(`üí∞ Estimate: <strong>$${est.low.toLocaleString()} ‚Äì $${est.high.toLocaleString()}</strong>`);
  el.innerHTML = lines.length ? lines.join('<br>') : 'Select your options above first';
}

function checkWarnings() {
  const answers = state.answers;
  C.steps.forEach((step, i) => {
    if (!step.warnings) return;
    step.warnings.forEach(w => {
      const el = document.getElementById(`section-${i}-warning-${w.condition.replace(/[^a-z0-9]/gi,'')}`);
      if (!el) return;
      try { el.style.display = eval(w.condition) ? 'block' : 'none'; } catch(e) { el.style.display = 'none'; }
    });
  });
}

function updateProgress() {
  const total = C.steps.length + (C.estimate ? 1 : 0) + (C.leadCapture && C.leadCapture.enabled ? 1 : 0);
  const completed = state.completedSections.size;
  const fillEl = document.getElementById('progressFill');
  const textEl = document.getElementById('progressText');
  if (fillEl) fillEl.style.width = (completed / total) * 100 + '%';
  if (textEl) textEl.textContent = `${completed} of ${total}`;
}

async function submitLead() {
  const lc = C.leadCapture;
  const formData = {};
  let missing = false;
  lc.fields.forEach(f => {
    const el = document.getElementById(`form-${f.id}`);
    formData[f.id] = el ? el.value.trim() : '';
    if (f.required && !formData[f.id]) missing = true;
  });
  if (missing) { alert('Just need the required fields filled in üëç'); return; }

  const btn = document.getElementById('submitBtn');
  btn.textContent = 'Sending...'; btn.disabled = true;

  let selections = '';
  C.steps.forEach(step => {
    if (step.input.type === 'select' && state.answers[step.id]) {
      const opt = findOption(step.id, state.answers[step.id]);
      selections += `${step.title}: ${opt ? opt.label : state.answers[step.id]}\n`;
    }
    if (step.input.type === 'slider_group') {
      selections += step.input.sliders.map(s => `${s.label}: ${state.sliders[s.id] ? state.sliders[s.id].label : ''}`).join(', ') + '\n';
    }
    if (step.input.type === 'toggle_group') {
      const active = step.input.toggles.filter(t => state.toggles[t.id]).map(t => t.label);
      if (active.length) selections += `Extras: ${active.join(', ')}\n`;
    }
  });

  const est = calculateEstimate();
  const estText = est ? `$${est.low.toLocaleString()} ‚Äì $${est.high.toLocaleString()}` : 'Not calculated';

  try {
    if (lc.delivery.method === 'web3forms') {
      await fetch('https://api.web3forms.com/submit', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          access_key: lc.delivery.web3formsKey,
          subject: lc.delivery.emailSubject.replace('{business.name}', C.business.name),
          from_name: `${C.business.name} Quote Widget`,
          to: lc.delivery.notifyEmail,
          message: `NEW QUOTE ENQUIRY\n==================\n${Object.entries(formData).map(([k,v]) => `${k}: ${v}`).join('\n')}\n\nSELECTIONS\n==================\n${selections}\nESTIMATE SHOWN: ${estText}`.trim(),
          ...formData, estimate_range: estText, selections_summary: selections,
        }),
      });
    }
  } catch (err) { console.error(err); }

  document.getElementById('leadFormContainer').style.display = 'none';
  document.getElementById('successMsg').style.display = 'block';
  const idx = C.steps.length + (C.estimate ? 1 : 0);
  const sid = `section-${idx}`;
  document.getElementById(sid).classList.add('completed');
  state.completedSections.add(sid);
  document.getElementById(sid + '-preview').innerHTML = '<span class="selected">‚úì Sent!</span>';
  updateProgress();
}

function getPreview(step) {
  if (step.input.type === 'select' && state.answers[step.id]) {
    const opt = step.input.options.find(o => o.value === state.answers[step.id]);
    return `<span class="selected">‚úì ${opt ? opt.label : state.answers[step.id]}</span>`;
  }
  return step.preview;
}

init();
</script>
</body>
</html>
