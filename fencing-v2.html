<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fencing Quote Estimator — Perth, WA | iTabs</title>
<style>
/* ═══════════════════════════════════════════════════════════
   iTabs Widget Engine v2.0 — Styles
   ═══════════════════════════════════════════════════════════ */
:root {
  --itabs-primary: #F59E0B;
  --itabs-secondary: #FFFFFF;
  --itabs-accent: #F59E0B;
  --itabs-bg: #0c1117;
  --itabs-card: #151c25;
  --itabs-card-hover: #1a2332;
  --itabs-border: #222d3a;
  --itabs-text: #e8ecf1;
  --itabs-text-muted: #8896a7;
  --itabs-text-dim: #5a6a7d;
  --itabs-success: #22c55e;
  --itabs-error: #ef4444;
  --itabs-radius: 12px;
  --itabs-font: 'Segoe UI', system-ui, -apple-system, sans-serif;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #080b10;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  padding: 12px;
  font-family: var(--itabs-font);
}
.itabs-widget {
  font-family: var(--itabs-font);
  color: var(--itabs-text);
  background: var(--itabs-bg);
  max-width: 540px;
  width: 100%;
  margin: 0 auto;
  padding: 16px;
  box-sizing: border-box;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}
.itabs-widget *, .itabs-widget *::before, .itabs-widget *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
.itabs-header { text-align: center; padding: 20px 0 16px; }
.itabs-header h1 { font-size: 1.4rem; font-weight: 700; color: var(--itabs-text); margin-bottom: 6px; }
.itabs-header p { font-size: 0.9rem; color: var(--itabs-text-muted); }
.itabs-business-name {
  font-size: 0.8rem; color: var(--itabs-primary); font-weight: 600;
  margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em;
}
.itabs-progress { display: flex; align-items: center; gap: 8px; padding: 12px 0 20px; }
.itabs-progress-bar { flex: 1; height: 6px; background: var(--itabs-border); border-radius: 3px; overflow: hidden; }
.itabs-progress-fill { height: 100%; background: var(--itabs-primary); border-radius: 3px; transition: width 0.4s ease; }
.itabs-progress-text { font-size: 0.75rem; color: var(--itabs-text-dim); white-space: nowrap; font-weight: 600; }
.itabs-running-total {
  display: flex; justify-content: space-between; align-items: center;
  background: var(--itabs-card); border: 1px solid var(--itabs-border);
  border-radius: var(--itabs-radius); padding: 10px 16px; margin-bottom: 16px; font-size: 0.85rem;
}
.itabs-running-total-label { color: var(--itabs-text-muted); }
.itabs-running-total-amount { font-size: 1.1rem; font-weight: 700; color: var(--itabs-primary); }
.itabs-step { animation: itabs-fadeIn 0.3s ease; }
@keyframes itabs-fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.itabs-step-title { font-size: 1.15rem; font-weight: 700; color: var(--itabs-text); margin-bottom: 8px; }
.itabs-step-help {
  font-size: 0.85rem; color: var(--itabs-text-muted); margin-bottom: 16px;
  padding: 10px 14px; background: rgba(59, 130, 246, 0.08);
  border-left: 3px solid var(--itabs-primary);
  border-radius: 0 var(--itabs-radius) var(--itabs-radius) 0; line-height: 1.6;
}
.itabs-step-required { color: var(--itabs-error); font-size: 0.75rem; margin-left: 4px; }
.itabs-options { display: flex; flex-direction: column; gap: 10px; }
.itabs-option-card {
  display: flex; align-items: center; gap: 14px; padding: 14px 16px;
  background: var(--itabs-card); border: 2px solid var(--itabs-border);
  border-radius: var(--itabs-radius); cursor: pointer; transition: all 0.2s ease;
  user-select: none; -webkit-tap-highlight-color: transparent;
}
.itabs-option-card:hover { background: var(--itabs-card-hover); border-color: var(--itabs-text-dim); }
.itabs-option-card.selected { border-color: var(--itabs-primary); background: rgba(245, 158, 11, 0.06); }
.itabs-option-indicator {
  width: 22px; height: 22px; min-width: 22px; border-radius: 50%;
  border: 2px solid var(--itabs-text-dim); display: flex; align-items: center;
  justify-content: center; transition: all 0.2s ease;
}
.itabs-option-card.selected .itabs-option-indicator { border-color: var(--itabs-primary); background: var(--itabs-primary); }
.itabs-option-indicator::after {
  content: ''; width: 8px; height: 8px; border-radius: 50%;
  background: transparent; transition: background 0.2s ease;
}
.itabs-option-card.selected .itabs-option-indicator::after { background: var(--itabs-bg); }
.itabs-option-card[data-multi] .itabs-option-indicator { border-radius: 4px; }
.itabs-option-card[data-multi].selected .itabs-option-indicator::after {
  width: 10px; height: 6px; border-radius: 0; background: transparent;
  border-bottom: 2.5px solid var(--itabs-bg); border-left: 2.5px solid var(--itabs-bg);
  transform: rotate(-45deg); margin-top: -2px;
}
.itabs-option-content { flex: 1; }
.itabs-option-label { font-size: 0.95rem; font-weight: 600; color: var(--itabs-text); }
.itabs-option-desc { font-size: 0.8rem; color: var(--itabs-text-muted); margin-top: 2px; }
.itabs-option-price { font-size: 0.85rem; font-weight: 600; color: var(--itabs-primary); white-space: nowrap; }
.itabs-number-input { display: flex; align-items: center; gap: 12px; justify-content: center; padding: 16px 0; }
.itabs-number-btn {
  width: 48px; height: 48px; border-radius: 50%; border: 2px solid var(--itabs-border);
  background: var(--itabs-card); color: var(--itabs-text); font-size: 1.4rem;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.15s ease; -webkit-tap-highlight-color: transparent;
}
.itabs-number-btn:hover { border-color: var(--itabs-primary); background: var(--itabs-card-hover); }
.itabs-number-btn:active { transform: scale(0.95); }
.itabs-number-value input {
  background: transparent; border: none; color: var(--itabs-text);
  font-size: 2rem; font-weight: 700; text-align: center; width: 100px;
  outline: none; font-family: inherit;
}
.itabs-number-unit { font-size: 0.85rem; color: var(--itabs-text-muted); text-align: center; margin-top: 4px; }
.itabs-range-wrap { padding: 16px 0; }
.itabs-range-display { text-align: center; font-size: 1.6rem; font-weight: 700; color: var(--itabs-text); margin-bottom: 16px; }
.itabs-range-display .unit { font-size: 0.9rem; color: var(--itabs-text-muted); font-weight: 500; }
.itabs-range-input {
  width: 100%; height: 6px; -webkit-appearance: none; appearance: none;
  background: var(--itabs-border); border-radius: 3px; outline: none;
}
.itabs-range-input::-webkit-slider-thumb {
  -webkit-appearance: none; width: 28px; height: 28px; border-radius: 50%;
  background: var(--itabs-primary); cursor: pointer; border: 3px solid var(--itabs-bg);
  box-shadow: 0 0 0 2px var(--itabs-primary);
}
.itabs-range-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--itabs-text-dim); margin-top: 8px; }
.itabs-textarea {
  width: 100%; min-height: 100px; padding: 14px; background: var(--itabs-card);
  border: 2px solid var(--itabs-border); border-radius: var(--itabs-radius);
  color: var(--itabs-text); font-size: 0.9rem; font-family: inherit;
  line-height: 1.5; resize: vertical; outline: none; transition: border-color 0.2s ease;
}
.itabs-textarea::placeholder { color: var(--itabs-text-dim); }
.itabs-textarea:focus { border-color: var(--itabs-primary); }
.itabs-contact-form { display: flex; flex-direction: column; gap: 12px; }
.itabs-form-field { display: flex; flex-direction: column; gap: 4px; }
.itabs-form-label { font-size: 0.85rem; font-weight: 600; color: var(--itabs-text-muted); }
.itabs-form-label .required { color: var(--itabs-error); }
.itabs-form-input {
  width: 100%; padding: 12px 14px; background: var(--itabs-card);
  border: 2px solid var(--itabs-border); border-radius: var(--itabs-radius);
  color: var(--itabs-text); font-size: 0.95rem; font-family: inherit;
  outline: none; transition: border-color 0.2s ease;
}
.itabs-form-input::placeholder { color: var(--itabs-text-dim); }
.itabs-form-input:focus { border-color: var(--itabs-primary); }
.itabs-form-input.error { border-color: var(--itabs-error); }
.itabs-form-error { font-size: 0.75rem; color: var(--itabs-error); min-height: 0; }
.itabs-nav { display: flex; gap: 10px; margin-top: 24px; }
.itabs-btn {
  flex: 1; padding: 14px 20px; border: none; border-radius: var(--itabs-radius);
  font-size: 0.95rem; font-weight: 600; font-family: inherit;
  cursor: pointer; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent;
}
.itabs-btn:active { transform: scale(0.98); }
.itabs-btn-back {
  background: var(--itabs-card); color: var(--itabs-text-muted);
  border: 2px solid var(--itabs-border); flex: 0 0 auto; padding: 14px 24px;
}
.itabs-btn-back:hover { background: var(--itabs-card-hover); color: var(--itabs-text); }
.itabs-btn-next { background: var(--itabs-primary); color: var(--itabs-bg); }
.itabs-btn-next:hover { filter: brightness(1.1); }
.itabs-btn-next:disabled { opacity: 0.4; cursor: not-allowed; filter: none; }
.itabs-btn-skip {
  background: transparent; color: var(--itabs-text-dim); font-size: 0.85rem;
  text-align: center; padding: 10px; cursor: pointer; border: none; font-family: inherit;
}
.itabs-btn-skip:hover { color: var(--itabs-text-muted); }
.itabs-summary { animation: itabs-fadeIn 0.3s ease; }
.itabs-summary-title { font-size: 1.2rem; font-weight: 700; color: var(--itabs-text); margin-bottom: 4px; }
.itabs-summary-desc { font-size: 0.85rem; color: var(--itabs-text-muted); margin-bottom: 20px; }
.itabs-summary-section {
  background: var(--itabs-card); border: 1px solid var(--itabs-border);
  border-radius: var(--itabs-radius); padding: 16px; margin-bottom: 12px;
}
.itabs-summary-section-title {
  font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.05em; color: var(--itabs-text-dim); margin-bottom: 12px;
}
.itabs-summary-row {
  display: flex; justify-content: space-between; align-items: flex-start;
  padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
}
.itabs-summary-row:last-child { border-bottom: none; }
.itabs-summary-row-label { font-size: 0.85rem; color: var(--itabs-text-muted); flex: 1; }
.itabs-summary-row-value { font-size: 0.9rem; font-weight: 600; color: var(--itabs-text); text-align: right; max-width: 60%; }
.itabs-summary-total {
  display: flex; justify-content: space-between; align-items: center;
  padding: 16px; background: rgba(245, 158, 11, 0.08);
  border: 1px solid rgba(245, 158, 11, 0.2);
  border-radius: var(--itabs-radius); margin-bottom: 12px;
}
.itabs-summary-total-label { font-size: 0.9rem; font-weight: 600; color: var(--itabs-text); }
.itabs-summary-total-amount { font-size: 1.5rem; font-weight: 700; color: var(--itabs-primary); }
.itabs-summary-disclaimer { font-size: 0.75rem; color: var(--itabs-text-dim); text-align: center; font-style: italic; margin-bottom: 16px; }
.itabs-summary-actions { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
.itabs-btn-copy {
  padding: 14px 20px; background: var(--itabs-primary); color: var(--itabs-bg);
  border: none; border-radius: var(--itabs-radius); font-size: 0.95rem;
  font-weight: 700; font-family: inherit; cursor: pointer; transition: all 0.2s ease; text-align: center;
}
.itabs-btn-copy:hover { filter: brightness(1.1); }
.itabs-btn-copy.copied { background: var(--itabs-success); }
.itabs-btn-restart {
  padding: 10px 20px; background: transparent; color: var(--itabs-text-dim);
  border: none; font-size: 0.85rem; font-family: inherit; cursor: pointer; text-align: center;
}
.itabs-btn-restart:hover { color: var(--itabs-text-muted); }
.itabs-summary-edit { font-size: 0.75rem; color: var(--itabs-primary); cursor: pointer; margin-left: 8px; opacity: 0.7; }
.itabs-summary-edit:hover { opacity: 1; }
.itabs-loading { display: flex; align-items: center; justify-content: center; padding: 60px 20px; color: var(--itabs-text-muted); font-size: 0.9rem; }
.itabs-error { padding: 20px; text-align: center; color: var(--itabs-error); font-size: 0.9rem; }
@media (min-width: 480px) {
  .itabs-widget { padding: 24px; }
  .itabs-header h1 { font-size: 1.6rem; }
  .itabs-option-card { padding: 16px 20px; }
}
</style>
</head>
<body>

<div id="itabs-widget"></div>

<script>
// ═══════════════════════════════════════════════════════════
// CONFIG — Fencing Perth
// ═══════════════════════════════════════════════════════════
var ITABS_CONFIG = {
  trade: { id: "fencing", name: "Fencing", region: "Perth, WA" },
  business: {
    name: "Perth Fencing Pros",
    logo: "", phone: "",
    colors: { primary: "#F59E0B", secondary: "#FFFFFF", accent: "#F59E0B" }
  },
  settings: {
    showPricing: true,
    pricingDisclaimer: "Estimates are approximate and may vary based on site conditions, soil type, and access. A site visit is usually required for an accurate quote.",
    currency: "AUD", currencySymbol: "$",
    summaryTitle: "How much is my fence?"
  },
  steps: [
    {
      id: "fence_type", title: "What type of fence do you need?", type: "single_select", required: true,
      helpText: "Most Perth homes use Colorbond for low maintenance \u2014 it handles the heat, won\u2019t rot, and comes in heaps of colours. Timber gives a classic look but needs staining every 2\u20133 years. Aluminium suits pool fencing or a modern street frontage.",
      options: [
        { id: "colorbond", label: "Colorbond Steel", description: "Low maintenance, durable steel fencing. Most popular in Perth.", pricing: { type: "per_unit", amount: 95, unit: "metre" } },
        { id: "timber", label: "Timber", description: "Classic wooden fence panels. Great look, needs more upkeep.", pricing: { type: "per_unit", amount: 110, unit: "metre" } },
        { id: "aluminium", label: "Aluminium", description: "Modern, rust-proof. Popular for pool fencing and front yards.", pricing: { type: "per_unit", amount: 130, unit: "metre" } },
        { id: "hardifence", label: "HardieFence", description: "Cement composite panels. Solid, quiet, low maintenance.", pricing: { type: "per_unit", amount: 140, unit: "metre" } }
      ]
    },
    {
      id: "length", title: "How many metres of fencing?", type: "number_input", required: true,
      helpText: "A standard Perth residential block is about 50m total perimeter. Just measure the sections you need fenced \u2014 most people don\u2019t do the whole lot. If you\u2019re not sure, pace it out (one big step \u2248 1 metre).",
      min: 1, max: 200, step: 1, unit: "metres", default: 20,
      pricing: { type: "multiplier" }
    },
    {
      id: "height", title: "What height fence?", type: "single_select", required: true,
      helpText: "Standard boundary fences in Perth are 1.8m (6 foot). Under the WA Dividing Fences Act, your neighbour generally shares the cost of a standard 1.8m fence. Anything taller is your cost. Pool fencing must be at least 1.2m by law.",
      options: [
        { id: "standard", label: "1.8m \u2014 Standard height", description: "Most common. Meets Dividing Fences Act for cost sharing.", pricing: { type: "fixed", amount: 0 } },
        { id: "pool", label: "1.2m \u2014 Pool fence height", description: "Minimum for WA pool fencing compliance.", pricing: { type: "fixed", amount: 0 } },
        { id: "extra", label: "2.1m+ \u2014 Extra height", description: "More privacy or security. Common near busy roads.", pricing: { type: "fixed", amount: 300 } }
      ]
    },
    {
      id: "gate", title: "Do you need a gate?", type: "single_select", required: true,
      helpText: "WA law requires a self-closing, self-latching gate for pool fencing. For boundary fencing, a pedestrian gate gives side access. Double gates let you get a trailer or bobcat through.",
      options: [
        { id: "none", label: "No gate needed", pricing: { type: "fixed", amount: 0 } },
        { id: "pedestrian", label: "Pedestrian gate", description: "Standard single gate for foot access.", pricing: { type: "fixed", amount: 450 } },
        { id: "double", label: "Double gate", description: "Wide gate for vehicle or trailer access.", pricing: { type: "fixed", amount: 850 } },
        { id: "both", label: "Both \u2014 pedestrian + double gate", description: "Side access plus vehicle access.", pricing: { type: "fixed", amount: 1250 } }
      ]
    },
    {
      id: "access", title: "What\u2019s the site access like?", type: "single_select", required: true,
      helpText: "This matters because the fencer may need to get materials, a bobcat, or a post hole borer to the work area. Narrow access means more hand-digging which adds time and cost.",
      options: [
        { id: "easy", label: "Easy \u2014 wide side access or open yard", description: "Machinery can get straight to the fence line.", pricing: { type: "fixed", amount: 0 } },
        { id: "moderate", label: "Moderate \u2014 narrow side gate", description: "Materials can get through but tight for machinery.", pricing: { type: "fixed", amount: 200 } },
        { id: "difficult", label: "Difficult \u2014 no side access or rear only", description: "Everything carried by hand. More labour required.", pricing: { type: "fixed", amount: 500 } }
      ]
    },
    {
      id: "removal", title: "Is there an old fence to remove?", type: "single_select", required: false,
      helpText: "If there\u2019s an existing fence, it usually needs to come out before the new one goes in. The fencer will remove it and take it to the tip. Asbestos fencing (common in older Perth homes) requires specialist removal \u2014 mention it in the notes if you think it might be asbestos.",
      options: [
        { id: "no", label: "No \u2014 new fence only", pricing: { type: "fixed", amount: 0 } },
        { id: "yes", label: "Yes \u2014 remove and dispose of old fence", pricing: { type: "per_unit", amount: 15, unit: "metre" } }
      ]
    },
    {
      id: "notes", title: "Anything else the fencer should know?", type: "text_input", required: false,
      helpText: "Mention things like sloping ground, retaining walls, trees near the fence line, limestone rock, sandy soil, or if you think the old fence might be asbestos.",
      placeholder: "e.g. Ground slopes about 1m from front to back, there\u2019s a big tree near the back corner, neighbour has agreed to split the cost"
    }
  ],
  contact: {
    title: "Your Details",
    fields: [
      { id: "name", label: "Name", type: "text", required: true },
      { id: "phone", label: "Phone", type: "tel", required: true },
      { id: "email", label: "Email", type: "email", required: false },
      { id: "suburb", label: "Suburb", type: "text", required: true, placeholder: "e.g. Joondalup, Fremantle, Armadale" }
    ]
  },
  summary: {
    title: "Your Fence Quote Request",
    description: "Here\u2019s a summary of what you need. Copy this and send it to any fencing company for a quick quote.",
    includeEstimate: true,
    ctaText: "\uD83D\uDCCB Copy Quote Summary"
  },
  delivery: { method: "display" }
};

// ═══════════════════════════════════════════════════════════
// iTabs Widget Engine v2.0
// ═══════════════════════════════════════════════════════════
(function (CONFIG) {
  var container = document.getElementById('itabs-widget');
  if (!container) return;

  var C = CONFIG;
  var totalSteps = C.steps.length + 1;
  var currentStep = 0;
  var answers = {};
  var contactData = {};

  render();

  function render() {
    var html = '<div class="itabs-widget">';
    html += renderHeader();
    if (currentStep < C.steps.length) {
      html += renderProgress();
      if (C.settings.showPricing) html += renderRunningTotal();
      html += renderStep(C.steps[currentStep]);
      html += renderNav(C.steps[currentStep]);
    } else if (currentStep === C.steps.length) {
      html += renderProgress();
      if (C.settings.showPricing) html += renderRunningTotal();
      html += renderContact();
    } else {
      html += renderSummary();
    }
    html += '</div>';
    container.innerHTML = html;
    bindEvents();
  }

  function renderHeader() {
    var h = '<div class="itabs-header">';
    if (C.business && C.business.name) h += '<div class="itabs-business-name">' + esc(C.business.name) + '</div>';
    if (C.settings && C.settings.summaryTitle) h += '<h1>' + esc(C.settings.summaryTitle) + '</h1>';
    h += '</div>';
    return h;
  }

  function renderProgress() {
    var pct = (currentStep / totalSteps) * 100;
    return '<div class="itabs-progress">' +
      '<div class="itabs-progress-bar"><div class="itabs-progress-fill" style="width:' + pct + '%"></div></div>' +
      '<span class="itabs-progress-text">Step ' + (currentStep + 1) + ' of ' + totalSteps + '</span></div>';
  }

  function renderRunningTotal() {
    var total = calculateTotal();
    var sym = C.settings.currencySymbol || '$';
    return '<div class="itabs-running-total">' +
      '<span class="itabs-running-total-label">Estimated total</span>' +
      '<span class="itabs-running-total-amount">' + sym + formatNum(total) + '</span></div>';
  }

  function renderStep(step) {
    var h = '<div class="itabs-step">';
    h += '<div class="itabs-step-title">' + esc(step.title);
    if (step.required) h += '<span class="itabs-step-required">*</span>';
    h += '</div>';
    if (step.helpText) h += '<div class="itabs-step-help">' + esc(step.helpText) + '</div>';
    switch (step.type) {
      case 'single_select': h += renderSingleSelect(step); break;
      case 'multi_select':  h += renderMultiSelect(step); break;
      case 'number_input':  h += renderNumberInput(step); break;
      case 'range_slider':  h += renderRangeSlider(step); break;
      case 'text_input':    h += renderTextInput(step); break;
    }
    h += '</div>';
    return h;
  }

  function renderSingleSelect(step) {
    var cur = answers[step.id];
    var h = '<div class="itabs-options">';
    step.options.forEach(function (opt) {
      var sel = cur && cur.optionId === opt.id;
      h += '<div class="itabs-option-card' + (sel ? ' selected' : '') + '" data-step="' + step.id + '" data-option="' + opt.id + '">';
      h += '<div class="itabs-option-indicator"></div><div class="itabs-option-content">';
      h += '<div class="itabs-option-label">' + esc(opt.label) + '</div>';
      if (opt.description) h += '<div class="itabs-option-desc">' + esc(opt.description) + '</div>';
      h += '</div>';
      if (C.settings.showPricing && opt.pricing) h += '<div class="itabs-option-price">' + formatPricingLabel(opt.pricing) + '</div>';
      h += '</div>';
    });
    return h + '</div>';
  }

  function renderMultiSelect(step) {
    var cur = answers[step.id];
    var selected = (cur && cur.selectedIds) || [];
    var h = '<div class="itabs-options">';
    step.options.forEach(function (opt) {
      var sel = selected.indexOf(opt.id) >= 0;
      h += '<div class="itabs-option-card' + (sel ? ' selected' : '') + '" data-multi data-step="' + step.id + '" data-option="' + opt.id + '">';
      h += '<div class="itabs-option-indicator"></div><div class="itabs-option-content">';
      h += '<div class="itabs-option-label">' + esc(opt.label) + '</div>';
      if (opt.description) h += '<div class="itabs-option-desc">' + esc(opt.description) + '</div>';
      h += '</div>';
      if (C.settings.showPricing && opt.pricing) h += '<div class="itabs-option-price">' + formatPricingLabel(opt.pricing) + '</div>';
      h += '</div>';
    });
    return h + '</div>';
  }

  function renderNumberInput(step) {
    var val = (answers[step.id] && answers[step.id].value) || step.default || step.min || 1;
    if (!answers[step.id]) answers[step.id] = { value: val, label: val + (step.unit ? ' ' + step.unit : '') };
    var h = '<div class="itabs-number-input">';
    h += '<button class="itabs-number-btn" data-action="decrement" data-step="' + step.id + '">\u2212</button>';
    h += '<div class="itabs-number-value"><input type="number" id="num-' + step.id + '" value="' + val + '" min="' + (step.min||0) + '" max="' + (step.max||9999) + '" data-step="' + step.id + '"></div>';
    h += '<button class="itabs-number-btn" data-action="increment" data-step="' + step.id + '">+</button>';
    h += '</div>';
    if (step.unit) h += '<div class="itabs-number-unit">' + esc(step.unit) + '</div>';
    return h;
  }

  function renderRangeSlider(step) {
    var val = (answers[step.id] && answers[step.id].value) || step.default || step.min || 0;
    if (!answers[step.id]) answers[step.id] = { value: val, label: val + (step.unit ? ' ' + step.unit : '') };
    var h = '<div class="itabs-range-wrap">';
    h += '<div class="itabs-range-display"><span id="range-val-' + step.id + '">' + val + '</span>';
    if (step.unit) h += ' <span class="unit">' + esc(step.unit) + '</span>';
    h += '</div>';
    h += '<input type="range" class="itabs-range-input" id="range-' + step.id + '" min="' + (step.min||0) + '" max="' + (step.max||100) + '" step="' + (step.step||1) + '" value="' + val + '" data-step="' + step.id + '">';
    h += '<div class="itabs-range-labels"><span>' + (step.min||0) + '</span><span>' + (step.max||100) + '</span></div></div>';
    return h;
  }

  function renderTextInput(step) {
    var val = (answers[step.id] && answers[step.id].value) || '';
    return '<textarea class="itabs-textarea" id="text-' + step.id + '" data-step="' + step.id + '" placeholder="' + esc(step.placeholder||'') + '">' + esc(val) + '</textarea>';
  }

  function renderContact() {
    var h = '<div class="itabs-step"><div class="itabs-step-title">' + esc(C.contact.title || 'Your Details') + '</div>';
    h += '<div class="itabs-step-help">We just need a few details so the tradie can get back to you with an accurate quote.</div>';
    h += '<div class="itabs-contact-form">';
    C.contact.fields.forEach(function (f) {
      var val = contactData[f.id] || '';
      h += '<div class="itabs-form-field"><label class="itabs-form-label" for="contact-' + f.id + '">' + esc(f.label);
      if (f.required) h += ' <span class="required">*</span>';
      h += '</label><input class="itabs-form-input" type="' + (f.type||'text') + '" id="contact-' + f.id + '" data-field="' + f.id + '" value="' + esc(val) + '" placeholder="' + esc(f.placeholder||'') + '">';
      h += '<div class="itabs-form-error" id="error-' + f.id + '"></div></div>';
    });
    h += '</div></div>';
    h += '<div class="itabs-nav"><button class="itabs-btn itabs-btn-back" data-action="back">\u2190 Back</button>';
    h += '<button class="itabs-btn itabs-btn-next" data-action="submit-contact">See Your Estimate</button></div>';
    return h;
  }

  function renderNav(step) {
    var h = '<div class="itabs-nav">';
    if (currentStep > 0) h += '<button class="itabs-btn itabs-btn-back" data-action="back">\u2190 Back</button>';
    var nextLabel = (currentStep === C.steps.length - 1) ? 'Your Details \u2192' : 'Next \u2192';
    var disabled = step.required && !isStepAnswered(step) ? ' disabled' : '';
    h += '<button class="itabs-btn itabs-btn-next" data-action="next"' + disabled + '>' + nextLabel + '</button></div>';
    if (!step.required && !isStepAnswered(step)) {
      h += '<div style="text-align:center"><button class="itabs-btn-skip" data-action="skip">Skip this step</button></div>';
    }
    return h;
  }

  function renderSummary() {
    var sym = C.settings.currencySymbol || '$';
    var h = '<div class="itabs-summary">';
    h += '<div class="itabs-summary-title">' + esc(C.summary.title || 'Your Quote Summary') + '</div>';
    if (C.summary.description) {
      var desc = C.summary.description.replace('{{business.name}}', C.business ? C.business.name : 'the tradie');
      h += '<div class="itabs-summary-desc">' + esc(desc) + '</div>';
    }
    h += '<div class="itabs-summary-section"><div class="itabs-summary-section-title">Your Selections</div>';
    C.steps.forEach(function (step, i) {
      var a = answers[step.id];
      if (!a) return;
      var label = getAnswerDisplay(step, a);
      if (!label) return;
      h += '<div class="itabs-summary-row"><span class="itabs-summary-row-label">' + esc(step.title) + ' <span class="itabs-summary-edit" data-goto="' + i + '">edit</span></span>';
      h += '<span class="itabs-summary-row-value">' + esc(label) + '</span></div>';
    });
    h += '</div>';
    if (C.settings.showPricing && C.summary.includeEstimate) {
      var total = calculateTotal();
      var breakdown = getBreakdown();
      if (breakdown.length > 0) {
        h += '<div class="itabs-summary-section"><div class="itabs-summary-section-title">Price Breakdown</div>';
        breakdown.forEach(function (item) {
          h += '<div class="itabs-summary-row"><span class="itabs-summary-row-label">' + esc(item.label) + '</span>';
          h += '<span class="itabs-summary-row-value">' + sym + formatNum(item.amount) + '</span></div>';
        });
        h += '</div>';
      }
      h += '<div class="itabs-summary-total"><span class="itabs-summary-total-label">Estimated Total</span>';
      h += '<span class="itabs-summary-total-amount">' + sym + formatNum(total) + '</span></div>';
      if (C.settings.pricingDisclaimer) h += '<div class="itabs-summary-disclaimer">' + esc(C.settings.pricingDisclaimer) + '</div>';
    }
    h += '<div class="itabs-summary-section"><div class="itabs-summary-section-title">Your Details</div>';
    C.contact.fields.forEach(function (f) {
      if (!contactData[f.id]) return;
      h += '<div class="itabs-summary-row"><span class="itabs-summary-row-label">' + esc(f.label) + '</span>';
      h += '<span class="itabs-summary-row-value">' + esc(contactData[f.id]) + '</span></div>';
    });
    h += '</div>';
    h += '<div class="itabs-summary-actions"><button class="itabs-btn-copy" data-action="copy">' + esc(C.summary.ctaText || 'Copy Quote Summary') + '</button>';
    h += '<button class="itabs-btn-restart" data-action="restart">Start Over</button></div></div>';
    return h;
  }

  // ── Events ──────────────────────────────────────────
  function bindEvents() {
    container.querySelectorAll('.itabs-option-card').forEach(function (card) {
      card.addEventListener('click', function () {
        handleOptionClick(this.getAttribute('data-step'), this.getAttribute('data-option'), this.hasAttribute('data-multi'));
      });
    });
    container.querySelectorAll('.itabs-number-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        handleNumberBtn(this.getAttribute('data-step'), this.getAttribute('data-action'));
      });
    });
    container.querySelectorAll('.itabs-number-value input').forEach(function (inp) {
      inp.addEventListener('change', function () { handleNumberChange(this.getAttribute('data-step'), this.value); });
    });
    container.querySelectorAll('.itabs-range-input').forEach(function (slider) {
      slider.addEventListener('input', function () { handleRangeChange(this.getAttribute('data-step'), this.value); });
    });
    container.querySelectorAll('.itabs-textarea').forEach(function (ta) {
      ta.addEventListener('input', function () { handleTextChange(this.getAttribute('data-step'), this.value); });
    });
    container.querySelectorAll('.itabs-form-input').forEach(function (inp) {
      inp.addEventListener('input', function () { contactData[this.getAttribute('data-field')] = this.value; });
    });
    container.querySelectorAll('[data-action="next"]').forEach(function (b) { b.addEventListener('click', function () { goNext(); }); });
    container.querySelectorAll('[data-action="back"]').forEach(function (b) { b.addEventListener('click', function () { goBack(); }); });
    container.querySelectorAll('[data-action="skip"]').forEach(function (b) { b.addEventListener('click', function () { goNext(true); }); });
    container.querySelectorAll('[data-action="submit-contact"]').forEach(function (b) { b.addEventListener('click', function () { submitContact(); }); });
    container.querySelectorAll('[data-action="copy"]').forEach(function (b) { b.addEventListener('click', function () { copySummary(this); }); });
    container.querySelectorAll('[data-action="restart"]').forEach(function (b) { b.addEventListener('click', function () { restart(); }); });
    container.querySelectorAll('[data-goto]').forEach(function (l) {
      l.addEventListener('click', function () { currentStep = parseInt(this.getAttribute('data-goto')); render(); });
    });
  }

  // ── Handlers ────────────────────────────────────────
  function handleOptionClick(stepId, optId, isMulti) {
    var step = C.steps.find(function (s) { return s.id === stepId; });
    var opt = step.options.find(function (o) { return o.id === optId; });
    if (isMulti) {
      if (!answers[stepId]) answers[stepId] = { selectedIds: [], labels: [], options: [] };
      var idx = answers[stepId].selectedIds.indexOf(optId);
      if (idx >= 0) { answers[stepId].selectedIds.splice(idx, 1); answers[stepId].labels.splice(idx, 1); answers[stepId].options.splice(idx, 1); }
      else { answers[stepId].selectedIds.push(optId); answers[stepId].labels.push(opt.label); answers[stepId].options.push(opt); }
    } else {
      answers[stepId] = { optionId: optId, label: opt.label, option: opt };
    }
    render();
  }

  function handleNumberBtn(stepId, action) {
    var step = C.steps.find(function (s) { return s.id === stepId; });
    var cur = (answers[stepId] && answers[stepId].value) || step.default || step.min || 1;
    var sz = step.step || 1;
    var nv = action === 'increment' ? cur + sz : cur - sz;
    nv = Math.max(step.min||0, Math.min(step.max||9999, nv));
    answers[stepId] = { value: nv, label: nv + (step.unit ? ' ' + step.unit : '') };
    render();
  }

  function handleNumberChange(stepId, val) {
    var step = C.steps.find(function (s) { return s.id === stepId; });
    var num = parseFloat(val) || step.min || 1;
    num = Math.max(step.min||0, Math.min(step.max||9999, num));
    answers[stepId] = { value: num, label: num + (step.unit ? ' ' + step.unit : '') };
    render();
  }

  function handleRangeChange(stepId, val) {
    var step = C.steps.find(function (s) { return s.id === stepId; });
    var num = parseFloat(val);
    answers[stepId] = { value: num, label: num + (step.unit ? ' ' + step.unit : '') };
    var d = container.querySelector('#range-val-' + stepId);
    if (d) d.textContent = num;
  }

  function handleTextChange(stepId, val) { answers[stepId] = { value: val, label: val }; }

  function goNext(skip) {
    if (!skip && currentStep < C.steps.length) {
      var step = C.steps[currentStep];
      if (step.required && !isStepAnswered(step)) return;
    }
    currentStep++;
    render();
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function goBack() {
    if (currentStep > 0) { currentStep--; render(); container.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
  }

  function submitContact() {
    var valid = true;
    C.contact.fields.forEach(function (f) {
      var errEl = container.querySelector('#error-' + f.id);
      var inputEl = container.querySelector('#contact-' + f.id);
      contactData[f.id] = inputEl ? inputEl.value.trim() : '';
      if (f.required && !contactData[f.id]) {
        valid = false;
        if (errEl) errEl.textContent = f.label + ' is required';
        if (inputEl) inputEl.classList.add('error');
      } else { if (errEl) errEl.textContent = ''; if (inputEl) inputEl.classList.remove('error'); }
    });
    if (!valid) return;
    currentStep = C.steps.length + 1;
    render();
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function restart() { currentStep = 0; answers = {}; contactData = {}; render(); container.scrollIntoView({ behavior: 'smooth', block: 'start' }); }

  function isStepAnswered(step) {
    var a = answers[step.id];
    if (!a) return false;
    switch (step.type) {
      case 'single_select': return !!a.optionId;
      case 'multi_select':  return a.selectedIds && a.selectedIds.length > 0;
      case 'number_input':  return a.value !== undefined;
      case 'range_slider':  return a.value !== undefined;
      case 'text_input':    return a.value && a.value.trim().length > 0;
      default: return false;
    }
  }

  // ── Pricing ─────────────────────────────────────────
  function calculateTotal() {
    var total = 0;
    var mult = getMultiplierValue();
    C.steps.forEach(function (step) {
      var a = answers[step.id];
      if (!a) return;
      if (step.type === 'single_select' && a.option && a.option.pricing) total += resolvePricing(a.option.pricing, mult);
      if (step.type === 'multi_select' && a.options) a.options.forEach(function (o) { if (o.pricing) total += resolvePricing(o.pricing, mult); });
      if ((step.type === 'number_input' || step.type === 'range_slider') && step.pricing && step.pricing.type === 'fixed') total += step.pricing.amount || 0;
    });
    return Math.round(total);
  }

  function getMultiplierValue() {
    var val = 1;
    C.steps.forEach(function (step) {
      if (step.pricing && step.pricing.type === 'multiplier') { var a = answers[step.id]; if (a && a.value !== undefined) val = a.value; }
    });
    return val;
  }

  function resolvePricing(p, mult) {
    if (!p) return 0;
    if (p.type === 'fixed') return p.amount || 0;
    if (p.type === 'per_unit') return (p.amount || 0) * mult;
    return 0;
  }

  function getBreakdown() {
    var items = [];
    var mult = getMultiplierValue();
    C.steps.forEach(function (step) {
      var a = answers[step.id];
      if (!a) return;
      if (step.type === 'single_select' && a.option && a.option.pricing) {
        var amt = resolvePricing(a.option.pricing, mult);
        if (amt > 0) {
          var lbl = a.label;
          if (a.option.pricing.type === 'per_unit') lbl += ' (' + formatNum(a.option.pricing.amount) + '/' + (a.option.pricing.unit||'unit') + ' \u00d7 ' + mult + ')';
          items.push({ label: lbl, amount: amt });
        }
      }
      if (step.type === 'multi_select' && a.options) a.options.forEach(function (o) {
        if (o.pricing) { var amt = resolvePricing(o.pricing, mult); if (amt > 0) items.push({ label: o.label, amount: amt }); }
      });
    });
    return items;
  }

  // ── Helpers ─────────────────────────────────────────
  function getAnswerDisplay(step, a) {
    switch (step.type) {
      case 'single_select': return a.label;
      case 'multi_select':  return a.labels ? a.labels.join(', ') : '';
      case 'number_input': case 'range_slider': return a.label;
      case 'text_input':    return a.value;
      default: return '';
    }
  }

  function formatPricingLabel(p) {
    var sym = C.settings.currencySymbol || '$';
    if (p.type === 'fixed') return p.amount === 0 ? '' : '+' + sym + formatNum(p.amount);
    if (p.type === 'per_unit') return sym + formatNum(p.amount) + '/' + (p.unit||'unit');
    return '';
  }

  function copySummary(btn) {
    var sym = C.settings.currencySymbol || '$';
    var text = (C.summary.title || 'Quote Request Summary') + '\n' + '\u2501'.repeat(40) + '\n\n';
    C.steps.forEach(function (step) {
      var a = answers[step.id]; if (!a) return;
      var d = getAnswerDisplay(step, a); if (!d) return;
      text += step.title + ': ' + d + '\n';
    });
    if (C.settings.showPricing) {
      text += '\n' + '\u2501'.repeat(40) + '\n';
      text += 'Estimated Total: ' + sym + formatNum(calculateTotal()) + '\n';
      if (C.settings.pricingDisclaimer) text += C.settings.pricingDisclaimer + '\n';
    }
    text += '\n' + '\u2501'.repeat(40) + '\nCustomer Details\n';
    C.contact.fields.forEach(function (f) { if (contactData[f.id]) text += f.label + ': ' + contactData[f.id] + '\n'; });
    navigator.clipboard.writeText(text).then(function () {
      btn.textContent = '\u2713 Copied!'; btn.classList.add('copied');
      setTimeout(function () { btn.textContent = C.summary.ctaText || 'Copy Quote Summary'; btn.classList.remove('copied'); }, 2000);
    }).catch(function () {
      var ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      btn.textContent = '\u2713 Copied!'; btn.classList.add('copied');
    });
  }

  function esc(str) { if (!str) return ''; var d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
  function formatNum(n) { return n.toLocaleString('en-AU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }

})(ITABS_CONFIG);
</script>
</body>
</html>
