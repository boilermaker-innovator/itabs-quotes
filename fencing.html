<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iTabs Quote Estimator</title>

<!-- ============================================================
     iTabs Quotes Engine v1.0
     Config-driven interactive quote estimator
     
     HOW IT WORKS:
     - Edit WIDGET_CONFIG below to customise for any trade
     - The engine reads the config and renders everything
     - One engine, infinite trades
     ============================================================ -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WIDGET CONFIG â€” Edit this for each business/trade
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WIDGET_CONFIG = {

  business: {
    name: "Perth Fencing Pros",
    tagline: "Colorbond, Timber & Aluminium Fencing",
    phone: "",
    email: "",
    logo: "",
    website: "",
    location: "Perth, WA",
    socials: { facebook: "", instagram: "", google: "" }
  },

  branding: {
    mode: "dark",
    primaryColor: "#f59e0b",
    secondaryColor: "#d97706",
    backgroundColor: "#0c1117",
    cardBackground: "#151c25",
    hoverBackground: "#1a2332",
    darkBackground: "#0a0e14",
    borderColor: "#222d3a",
    textColor: "#e8ecf1",
    mutedText: "#8896a7",
    dimText: "#5a6a7d",
    successColor: "#22c55e",
    errorColor: "#ef4444",
    infoColor: "#3b82f6",
    fontFamily: "'Plus Jakarta Sans', sans-serif",
    monoFont: "'JetBrains Mono', monospace",
    borderRadius: "14px",
    googleFontsUrl: "https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap",
  },

  header: {
    icon: "ğŸ—ï¸",
    headline: "How much is my fence?",
    subtitle: "Tap through to get a ballpark price for your new fence. Takes about 60 seconds.",
    badge: "ğŸ“ Prices based on Perth, WA â€” 2025",
    disclaimer: "Estimates are approximate. Final pricing confirmed after site inspection.",
  },

  steps: [
    // â”€â”€ STEP 1: Fence Type â”€â”€
    {
      id: "fence_type",
      title: "What type of fence?",
      preview: "Tap to choose",
      input: {
        type: "select",
        columns: 1,
        autoAdvance: true,
        options: [
          {
            value: "colorbond",
            label: "Colorbond",
            icon: "ğŸ”©",
            description: "Steel panels. Most popular in Perth. Private, low maintenance, lasts 20+ years. 16 colours.",
            priceHint: "$90â€“$125/m",
            tags: [
              { text: "Most Popular in WA", highlight: true },
              { text: "10yr warranty" }
            ]
          },
          {
            value: "timber",
            label: "Timber Paling",
            icon: "ğŸªµ",
            description: "Natural look. Cheaper upfront but needs painting/staining every few years. Lasts 10â€“20 years.",
            priceHint: "$120â€“$200/m",
            tags: [
              { text: "Classic look" },
              { text: "More maintenance" }
            ]
          },
          {
            value: "aluminium",
            label: "Aluminium Slat",
            icon: "âœ¨",
            description: "Modern look. Won't rust â€” perfect for coastal Perth. Privacy with airflow. Lasts 50+ years.",
            priceHint: "$180â€“$300/m",
            tags: [
              { text: "Premium" },
              { text: "Coastal safe" }
            ]
          },
          {
            value: "pool",
            label: "Pool Fencing",
            icon: "ğŸŠ",
            description: "Glass, aluminium tubular, or perforated panels. Must meet Australian safety standards. Building permit required.",
            priceHint: "$200â€“$600/m",
            tags: [
              { text: "Compliance required" },
              { text: "Safety rated" }
            ]
          }
        ]
      },
      hints: [
        {
          tabLabel: "Compare",
          type: "comparison_table",
          columns: ["Feature", "Colorbond", "Timber", "Aluminium"],
          rows: [
            ["Privacy", "Full", "Full", "Varies"],
            ["Maintenance", "Minimal", "Regular", "Minimal"],
            ["Lifespan", "20â€“25 yrs", "10â€“20 yrs", "50+ yrs"],
            ["Coastal?", "OK", "Risky", "Best"],
            ["Termites?", "No risk", "Risk", "No risk"],
            ["Bushfire safe?", "Yes", "No", "Yes"],
          ],
          cellStyles: {
            "Minimal": "positive", "No risk": "positive", "Yes": "positive",
            "Full": "positive", "Best": "positive",
            "Regular": "negative", "Risk": "negative", "Risky": "negative", "No": "negative",
          }
        },
        {
          tabLabel: "Perth Tips",
          type: "tips",
          tips: [
            {
              icon: "ğŸŒŠ",
              title: "Near the coast?",
              text: "Aluminium slat is your best bet. Won't corrode from salt air. Worth the extra cost in Freo, Scarborough, or anywhere near the ocean."
            },
            {
              icon: "ğŸ”¥",
              title: "Bushfire zone?",
              text: "Colorbond is non-combustible â€” the go-to for hills areas like Kalamunda, Mundaring, and Roleystone. Timber is not recommended."
            },
            {
              icon: "ğŸ ",
              title: "Replacing old asbestos (Super 6)?",
              text: "Super 6 and Hardifence are no longer made. Most people switch to Colorbond â€” licensed removal is required for asbestos."
            },
          ]
        },
      ],
    },

    // â”€â”€ STEP 2: Size â”€â”€
    {
      id: "size",
      title: "How much fencing?",
      preview: "Length & height",
      input: {
        type: "slider_group",
        sliders: [
          {
            id: "length_m",
            label: "Total length (metres)",
            min: 5,
            max: 100,
            default: 20,
            step: 1,
            unit: "m",
            markers: ["5m", "Small yard ~15m", "Avg ~30m", "100m"],
          },
          {
            id: "height_m",
            label: "Height",
            min: 0,
            max: 3,
            default: 2,
            step: 1,
            unit: "",
            valueMap: [
              { value: 0, label: "0.9m (low)", numericValue: 0.9 },
              { value: 1, label: "1.2m (front fence)", numericValue: 1.2 },
              { value: 2, label: "1.8m (standard)", numericValue: 1.8 },
              { value: 3, label: "2.1m (extra tall)", numericValue: 2.1 },
            ],
            markers: ["0.9m", "1.2m", "1.8m", "2.1m"],
          }
        ]
      },
      hints: [
        {
          tabLabel: "Measuring Tips",
          type: "mixed",
          content: [
            {
              type: "paragraph",
              text: "Walk the fence line and count your steps. Each big step is roughly 1 metre. Or use Google Maps â€” right-click and \"Measure distance\" to get an estimate from above."
            },
            {
              type: "key_point",
              label: "Don't stress about exact numbers",
              text: "This gives you a ballpark. The fencing company will do a proper site measure when they quote â€” it's usually free."
            },
            {
              type: "tip",
              icon: "ğŸ“",
              title: "Typical Perth block sizes",
              text: "Standard 450mÂ² block: ~30m of side/rear fencing. Quarter acre (1,012mÂ²): ~50â€“60m. Duplex or villa: ~15â€“20m."
            }
          ]
        }
      ],
      warnings: [
        {
          condition: "answers.fence_type === 'pool' && getSliderNumeric('height_m') < 1.2",
          icon: "âš ï¸",
          title: "Pool fencing minimum 1.2m",
          text: "By Australian law, pool fencing must be at least 1.2m high. Heights below this won't pass inspection.",
          style: "error"
        }
      ]
    },

    // â”€â”€ STEP 3: Extras â”€â”€
    {
      id: "extras",
      title: "Any extras?",
      preview: "Gates, removal, etc",
      input: {
        type: "toggle_group",
        toggles: [
          { id: "gate", label: "Single pedestrian gate", icon: "ğŸšª", costHint: "Adds ~$350â€“$600" },
          { id: "drivegate", label: "Double/driveway gate", icon: "ğŸš—", costHint: "Adds ~$800â€“$1,500" },
          { id: "removal", label: "Old fence removal", icon: "ğŸ—‘ï¸", costHint: "Adds ~$15â€“$30/m" },
          { id: "slope", label: "Sloping block", icon: "ğŸ“", costHint: "Adds ~10â€“20% to labour" },
          { id: "plinth", label: "Plinth (gap filler under fence)", icon: "ğŸ§±", costHint: "Adds ~$15â€“$25/m" },
          { id: "lattice", label: "Lattice/slat top extension", icon: "ğŸŒ¿", costHint: "Adds ~$20â€“$35/m" },
        ]
      },
      hints: [
        {
          tabLabel: "What's Included?",
          type: "mixed",
          content: [
            {
              type: "paragraph",
              text: "A standard quote from most Perth fencers includes: posts, rails, panels, cement for footings, and basic install on flat ground. Here's what might cost extra:"
            },
            {
              type: "key_point",
              label: "âš ï¸ Asbestos fence (Super 6)?",
              text: "Needs licensed removal â€” usually $30â€“$60/m extra. Don't break it yourself, it's a health risk and you'll cop a fine."
            },
            {
              type: "key_point",
              label: "ğŸª¨ Rocky soil or limestone?",
              text: "Common in Perth â€” especially north of the river. May need core drilling for posts, which adds $10â€“$20 per post hole."
            }
          ]
        }
      ]
    },
  ],

  // â”€â”€ ESTIMATE DISPLAY â”€â”€
  estimate: {
    title: "Your ballpark price",
    preview: "Based on your selections",
    note: "Supply & install â€¢ incl. GST â€¢ Perth metro",
    hints: [
      {
        type: "key_point",
        label: "How accurate is this?",
        text: "This is a rough guide based on average Perth pricing in 2025. Your actual quote depends on soil type, access, specific materials, and the installer. Get 2â€“3 quotes to compare."
      },
      {
        type: "tip",
        icon: "ğŸ’¡",
        title: "Neighbour splitting costs?",
        text: "In WA, neighbours generally split the cost of a dividing fence 50/50. The Dividing Fences Act 1961 covers this â€” but have a chat with them first before getting quotes."
      }
    ]
  },

  // â”€â”€ PRICING LOGIC â”€â”€
  pricing: {
    unit: "metre",
    unitLabel: "per metre",
    basePriceStep: "fence_type",
    basePrices: {
      colorbond:  { low: 90, high: 125 },
      timber:     { low: 120, high: 200 },
      aluminium:  { low: 180, high: 300 },
      pool:       { low: 200, high: 600 },
    },
    quantitySource: "length_m",
    multipliers: [
      {
        source: "height_m",
        type: "value_map",
        values: { 0.9: 0.65, 1.2: 0.8, 1.8: 1.0, 2.1: 1.15 }
      }
    ],
    extras: [
      { id: "gate", type: "fixed", low: 350, high: 600, breakdownLabel: "Pedestrian gate" },
      { id: "drivegate", type: "fixed", low: 800, high: 1500, breakdownLabel: "Driveway gate" },
      { id: "removal", type: "per_unit", lowPerUnit: 15, highPerUnit: 30, breakdownLabel: "Old fence removal" },
      { id: "slope", type: "percentage", lowPercent: 10, highPercent: 20, breakdownLabel: "Sloping block" },
      { id: "plinth", type: "per_unit", lowPerUnit: 15, highPerUnit: 25, breakdownLabel: "Plinths" },
      { id: "lattice", type: "per_unit", lowPerUnit: 20, highPerUnit: 35, breakdownLabel: "Lattice top" },
    ],
    showBreakdown: true,
    roundTo: 0,
    minimumPrice: 500,
  },

  // â”€â”€ LEAD CAPTURE â”€â”€
  leadCapture: {
    enabled: true,
    title: "Get your actual quote",
    preview: "Free, no obligation",
    heading: "We've got your specs.",
    subheading: "Drop your details and we'll get back to you with an exact price â€” usually within 24 hours.",
    showSummary: true,
    fields: [
      { id: "name", label: "Your name", type: "text", placeholder: "e.g. Dave", required: true },
      { id: "contact", label: "Phone or email", type: "text", placeholder: "e.g. 0412 345 678", required: true },
      { id: "suburb", label: "Suburb", type: "text", placeholder: "e.g. Joondalup", required: false },
      { id: "notes", label: "Anything else we should know?", type: "textarea", placeholder: "e.g. Replacing old asbestos fence, dog keeps escaping...", required: false },
    ],
    submitText: "ğŸ“© Send My Quote Request",
    submitNote: "No spam. Just your quote.",
    successMessage: "Quote request sent!",
    successSubtext: "We'll be in touch within 24 hours with a proper price based on your specs.",
    delivery: {
      method: "web3forms",
      web3formsKey: "99a11c15-5c61-4765-99c5-673adec64b16",
      notifyEmail: "responses@itabs.ai",
      emailSubject: "New Fence Enquiry",
    }
  },

  socialProof: {
    enabled: false,
    rating: 4.9,
    reviewCount: 127,
    badges: ["Licensed & Insured", "Perth Local", "Free Quotes"],
  },

  footer: {
    showPoweredBy: true,
    poweredByUrl: "https://itabs.ai",
  }
};
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ENGINE â€” Everything below here is generic. Do not edit per client.
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<script>
// Load Google Fonts from config
if (WIDGET_CONFIG.branding.googleFontsUrl) {
  const link = document.createElement('link');
  link.rel = 'stylesheet';
  link.href = WIDGET_CONFIG.branding.googleFontsUrl;
  document.head.appendChild(link);
  const preconnect = document.createElement('link');
  preconnect.rel = 'preconnect';
  preconnect.href = 'https://fonts.googleapis.com';
  document.head.prepend(preconnect);
}
// Set page title
document.title = WIDGET_CONFIG.header.headline + ' | ' + WIDGET_CONFIG.business.name;
</script>

<style>
/* â•â•â• CSS VARIABLES â€” Set from config via JS â•â•â• */
:root {
  --bg-main: #0c1117;
  --bg-card: #151c25;
  --bg-hover: #1a2332;
  --bg-dark: #0a0e14;
  --border: #222d3a;
  --brand-primary: #f59e0b;
  --brand-secondary: #d97706;
  --brand-glow: rgba(245, 158, 11, 0.15);
  --accent-green: #22c55e;
  --accent-blue: #3b82f6;
  --accent-red: #ef4444;
  --text-primary: #e8ecf1;
  --text-secondary: #8896a7;
  --text-muted: #5a6a7d;
  --font-main: 'Plus Jakarta Sans', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --radius: 14px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font-main);
  background: var(--bg-main);
  color: var(--text-primary);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

.container {
  max-width: 520px;
  margin: 0 auto;
  padding: 20px 16px 40px;
}

/* â•â•â• HEADER â•â•â• */
.header { text-align: center; padding: 30px 0 25px; }
.header-icon { font-size: 2.5rem; margin-bottom: 12px; }
.header h1 {
  font-size: 1.6rem; font-weight: 800; margin-bottom: 6px;
  background: linear-gradient(135deg, var(--brand-primary), #fbbf24);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.header p { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.5; }
.header .badge-line {
  display: inline-block; background: var(--bg-card); border: 1px solid var(--border);
  padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; color: var(--text-muted); margin-top: 12px;
}

/* â•â•â• PROGRESS â•â•â• */
.progress-label {
  display: flex; justify-content: space-between; margin-bottom: 8px;
  font-size: 0.75rem; color: var(--text-muted);
}
.progress-bar {
  background: var(--bg-card); border-radius: 10px; height: 6px; margin-bottom: 25px; overflow: hidden;
}
.progress-fill {
  height: 100%; background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
  border-radius: 10px; width: 0%; transition: width 0.5s ease;
}

/* â•â•â• ACCORDION SECTIONS â•â•â• */
.itab-section {
  background: var(--bg-card); border-radius: var(--radius); margin-bottom: 14px;
  overflow: hidden; border: 1px solid var(--border); transition: all 0.3s ease; scroll-margin-top: 16px;
}
.itab-section:hover { border-color: rgba(245, 158, 11, 0.3); }
.itab-section.completed { border-color: var(--accent-green); }
.itab-section.completed .itab-number { background: var(--accent-green); }

.itab-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 16px; cursor: pointer; transition: background 0.2s;
}
.itab-header:hover { background: var(--bg-hover); }

.itab-title { display: flex; align-items: center; gap: 12px; }
.itab-number {
  width: 34px; height: 34px;
  background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 0.85rem; color: #000; flex-shrink: 0;
}
.itab-name { font-size: 1rem; font-weight: 600; }
.itab-preview { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
.itab-preview .selected { color: var(--accent-green); font-weight: 500; }

.i-button {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
  border: none; border-radius: 8px; color: #000; font-weight: 700; font-size: 1rem;
  cursor: pointer; transition: all 0.2s; font-family: serif; font-style: italic; flex-shrink: 0;
}
.i-button:hover { transform: scale(1.1); box-shadow: 0 0 20px var(--brand-glow); }
.i-button.active { background: var(--accent-green); color: white; }

.itab-content { display: none; padding: 0 16px 18px; border-top: 1px solid var(--border); }
.itab-content.show { display: block; animation: fadeInUp 0.3s ease; }

/* â•â•â• TABS â•â•â• */
.tabs {
  display: flex; gap: 6px; padding: 14px 0; border-bottom: 1px solid var(--border);
  margin-bottom: 14px; flex-wrap: wrap;
}
.tab {
  padding: 7px 14px; background: var(--bg-hover); border: none; border-radius: 8px;
  color: var(--text-secondary); cursor: pointer; font-family: var(--font-main);
  font-size: 0.85rem; font-weight: 500; transition: all 0.2s;
}
.tab:hover { color: var(--text-primary); }
.tab.active {
  background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
  color: #000; font-weight: 600;
}
.tab-panel { display: none; }
.tab-panel.show { display: block; }
.tab-panel h3 { color: var(--brand-primary); margin-bottom: 10px; font-size: 1rem; }
.tab-panel p { color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6; font-size: 0.9rem; }

/* â•â•â• SELECT OPTIONS â•â•â• */
.option-grid { display: grid; gap: 10px; margin: 10px 0; }
.option-grid.cols-2 { grid-template-columns: 1fr 1fr; }
.option-card {
  background: var(--bg-dark); border: 2px solid var(--border); border-radius: 12px;
  padding: 16px; cursor: pointer; transition: all 0.2s;
}
.option-card:hover { border-color: var(--brand-primary); background: var(--bg-hover); }
.option-card.selected { border-color: var(--accent-green); background: rgba(34, 197, 94, 0.05); }
.option-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.option-name { font-weight: 700; font-size: 1rem; }
.option-price { font-family: var(--font-mono); font-size: 0.85rem; color: var(--brand-primary); font-weight: 500; }
.option-desc { color: var(--text-muted); font-size: 0.82rem; line-height: 1.5; }
.option-check { display: none; color: var(--accent-green); font-weight: 700; font-size: 0.85rem; margin-top: 6px; }
.option-card.selected .option-check { display: inline; }
.option-tags { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
.option-tag {
  font-size: 0.7rem; padding: 3px 8px; border-radius: 6px;
  background: var(--bg-hover); color: var(--text-muted);
}
.option-tag.highlight { background: rgba(245, 158, 11, 0.15); color: var(--brand-primary); }

/* â•â•â• SLIDERS â•â•â• */
.slider-group { margin: 16px 0; }
.slider-label { display: flex; justify-content: space-between; margin-bottom: 8px; }
.slider-label span { color: var(--text-secondary); font-size: 0.9rem; }
.slider-value { font-family: var(--font-mono); color: var(--brand-primary); font-weight: 600; }
input[type="range"] {
  width: 100%; -webkit-appearance: none; appearance: none;
  height: 8px; background: var(--bg-dark); border-radius: 4px; outline: none;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 24px; height: 24px;
  background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
  border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}
input[type="range"]::-moz-range-thumb {
  width: 24px; height: 24px;
  background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
  border-radius: 50%; cursor: pointer; border: none;
}
.slider-markers {
  display: flex; justify-content: space-between; font-size: 0.7rem;
  color: var(--text-muted); margin-top: 4px;
}

/* â•â•â• TOGGLES â•â•â• */
.toggle-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 14px 0; border-bottom: 1px solid var(--border);
}
.toggle-row:last-child { border-bottom: none; }
.toggle-info .toggle-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; }
.toggle-info .toggle-cost { font-size: 0.8rem; color: var(--text-muted); }
.toggle-switch {
  width: 48px; height: 26px; background: var(--bg-dark); border-radius: 13px;
  border: 2px solid var(--border); cursor: pointer; position: relative;
  transition: all 0.3s; flex-shrink: 0;
}
.toggle-switch.on { background: var(--accent-green); border-color: var(--accent-green); }
.toggle-knob {
  width: 18px; height: 18px; background: white; border-radius: 50%;
  position: absolute; top: 2px; left: 2px; transition: all 0.3s;
}
.toggle-switch.on .toggle-knob { left: 24px; }

/* â•â•â• ESTIMATE BOX â•â•â• */
.estimate-box {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(217, 119, 6, 0.05));
  border: 2px solid var(--brand-primary); border-radius: var(--radius);
  padding: 24px; margin: 20px 0; text-align: center;
}
.est-label { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
.est-range { font-family: var(--font-mono); font-size: 2rem; font-weight: 700; color: var(--brand-primary); margin-bottom: 4px; }
.est-note { color: var(--text-muted); font-size: 0.78rem; }
.estimate-breakdown { margin-top: 16px; text-align: left; }
.breakdown-row {
  display: flex; justify-content: space-between; padding: 8px 0;
  border-bottom: 1px solid rgba(245, 158, 11, 0.1); font-size: 0.85rem;
}
.breakdown-row:last-child { border-bottom: none; }
.breakdown-row .br-label { color: var(--text-secondary); }
.breakdown-row .br-value { font-family: var(--font-mono); color: var(--text-primary); font-weight: 500; }

/* â•â•â• KEY POINTS & TIPS â•â•â• */
.key-point {
  background: var(--bg-dark); border-left: 4px solid var(--brand-primary);
  padding: 12px 16px; margin: 12px 0; border-radius: 0 8px 8px 0;
}
.key-point .kp-label {
  color: var(--brand-primary); font-weight: 600; font-size: 0.75rem;
  text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;
}
.key-point p { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0; }

.tip-card {
  background: rgba(59, 130, 246, 0.08); border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 10px; padding: 12px 14px; margin: 10px 0; font-size: 0.85rem;
}
.tip-card .tip-title { font-weight: 600; color: var(--accent-blue); margin-bottom: 4px; }
.tip-card p { color: var(--text-secondary); margin-bottom: 0; font-size: 0.83rem; }

.warning-card {
  border: 1px solid rgba(239,68,68,0.3); background: rgba(239,68,68,0.08);
  border-radius: 10px; padding: 12px 14px; margin: 10px 0; font-size: 0.85rem;
}
.warning-card .warning-title { font-weight: 600; color: var(--accent-red); margin-bottom: 4px; }
.warning-card p { color: var(--text-secondary); margin-bottom: 0; font-size: 0.83rem; }

/* â•â•â• COMPARISON TABLE â•â•â• */
.compare-table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 0.82rem; }
.compare-table th {
  text-align: left; padding: 10px 8px; color: var(--text-muted); font-weight: 600;
  border-bottom: 2px solid var(--border); font-size: 0.75rem;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.compare-table td { padding: 10px 8px; color: var(--text-secondary); border-bottom: 1px solid var(--border); }
.compare-table td:first-child { font-weight: 600; color: var(--text-primary); }
.compare-table .positive { color: var(--accent-green); }
.compare-table .negative { color: var(--accent-red); }

/* â•â•â• LEAD FORM â•â•â• */
.form-group { margin-bottom: 12px; text-align: left; }
.form-group label { display: block; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px; font-weight: 500; }
.form-group input, .form-group textarea {
  width: 100%; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text-primary); font-family: var(--font-main);
  font-size: 0.9rem; outline: none; transition: border-color 0.2s;
}
.form-group input:focus, .form-group textarea:focus { border-color: var(--brand-primary); }
.form-group textarea { resize: vertical; min-height: 70px; }

.submit-btn {
  width: 100%; padding: 14px;
  background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
  border: none; border-radius: 10px; color: #000; font-family: var(--font-main);
  font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; margin-top: 8px;
}
.submit-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px var(--brand-glow); }
.submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

.summary-box {
  background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px;
  padding: 14px; margin-bottom: 16px; font-size: 0.83rem;
}
.summary-label {
  font-weight: 600; color: var(--brand-primary); margin-bottom: 8px;
  font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;
}
.summary-content { color: var(--text-secondary); line-height: 1.8; }

.success-message { text-align: center; padding: 30px 20px; animation: fadeInUp 0.4s ease; }
.success-message .check-icon { font-size: 3rem; margin-bottom: 12px; }
.success-message h3 { color: var(--accent-green); margin-bottom: 8px; }
.success-message p { color: var(--text-secondary); font-size: 0.9rem; }

/* â•â•â• SOCIAL PROOF â•â•â• */
.social-proof {
  display: flex; align-items: center; justify-content: center; gap: 16px;
  padding: 12px 20px; background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); flex-wrap: wrap; font-size: 0.85rem;
  color: var(--text-muted); margin-bottom: 20px;
}
.sp-stars { color: var(--brand-primary); letter-spacing: 1px; }
.sp-rating { color: var(--brand-primary); font-weight: 600; }
.sp-badge {
  background: var(--bg-hover); padding: 4px 10px; border-radius: 20px;
  font-size: 0.75rem; white-space: nowrap;
}

/* â•â•â• FOOTER â•â•â• */
.powered-by {
  text-align: center; padding: 30px 0 10px; font-size: 0.75rem; color: var(--text-muted);
}
.powered-by a { color: var(--brand-primary); text-decoration: none; font-weight: 600; }

/* â•â•â• ANIMATIONS â•â•â• */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<div class="container" id="app">
  <!-- Rendered by engine -->
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// iTabs Quotes Engine v1.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const C = WIDGET_CONFIG;

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  answers: {},       // { step_id: value } for selects
  sliders: {},       // { slider_id: { raw, numeric, label } }
  toggles: {},       // { toggle_id: true/false }
  openSection: null,
  completedSections: new Set(),
};

// â”€â”€ APPLY BRANDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyBranding() {
  const b = C.branding;
  const r = document.documentElement.style;
  r.setProperty('--bg-main', b.backgroundColor);
  r.setProperty('--bg-card', b.cardBackground);
  r.setProperty('--bg-hover', b.hoverBackground);
  r.setProperty('--bg-dark', b.darkBackground);
  r.setProperty('--border', b.borderColor);
  r.setProperty('--brand-primary', b.primaryColor);
  r.setProperty('--brand-secondary', b.secondaryColor);
  r.setProperty('--text-primary', b.textColor);
  r.setProperty('--text-secondary', b.mutedText);
  r.setProperty('--text-muted', b.dimText);
  r.setProperty('--accent-green', b.successColor);
  r.setProperty('--accent-red', b.errorColor);
  r.setProperty('--accent-blue', b.infoColor);
  r.setProperty('--font-main', b.fontFamily);
  r.setProperty('--font-mono', b.monoFont);
  r.setProperty('--radius', b.borderRadius);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  applyBranding();
  initSliderDefaults();
  render();
  // Auto-open first section
  setTimeout(() => toggleSection(0), 300);
}

function initSliderDefaults() {
  C.steps.forEach(step => {
    if (step.input.type === 'slider_group') {
      step.input.sliders.forEach(s => {
        const raw = s.default;
        if (s.valueMap) {
          const mapped = s.valueMap.find(v => v.value === raw);
          state.sliders[s.id] = {
            raw, numeric: mapped ? mapped.numericValue : raw, label: mapped ? mapped.label : raw + (s.unit || '')
          };
        } else {
          state.sliders[s.id] = { raw, numeric: raw, label: raw + (s.unit || '') };
        }
      });
    }
    if (step.input.type === 'toggle_group') {
      step.input.toggles.forEach(t => { state.toggles[t.id] = false; });
    }
  });
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const app = document.getElementById('app');
  let html = '';

  // Header
  html += renderHeader();

  // Social proof
  if (C.socialProof && C.socialProof.enabled) html += renderSocialProof();

  // Progress
  const totalSections = C.steps.length + (C.estimate ? 1 : 0) + (C.leadCapture && C.leadCapture.enabled ? 1 : 0);
  html += `
    <div class="progress-label">
      <span>Your quote</span>
      <span id="progressText">0 of ${totalSections}</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>`;

  // Steps
  C.steps.forEach((step, i) => {
    html += renderSection(step, i);
  });

  // Estimate section
  if (C.estimate) {
    html += renderEstimateSection(C.steps.length);
  }

  // Lead capture section
  if (C.leadCapture && C.leadCapture.enabled) {
    html += renderLeadSection(C.steps.length + (C.estimate ? 1 : 0));
  }

  // Footer
  if (C.footer && C.footer.showPoweredBy) {
    html += `<div class="powered-by">Powered by <a href="${C.footer.poweredByUrl}" target="_blank">iTabs</a> Â· Interactive tools that convert</div>`;
  }

  app.innerHTML = html;
}

function renderHeader() {
  const h = C.header;
  return `
    <div class="header">
      <div class="header-icon">${h.icon}</div>
      <h1>${h.headline}</h1>
      <p>${h.subtitle}</p>
      ${h.badge ? `<span class="badge-line">${h.badge}</span>` : ''}
    </div>`;
}

function renderSocialProof() {
  const sp = C.socialProof;
  const stars = 'â˜…'.repeat(Math.floor(sp.rating));
  return `
    <div class="social-proof">
      <span class="sp-stars">${stars}</span>
      <span class="sp-rating">${sp.rating} from ${sp.reviewCount} reviews</span>
      ${sp.badges.map(b => `<span class="sp-badge">${b}</span>`).join('')}
    </div>`;
}

// â”€â”€ SECTION RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSection(step, index) {
  const sectionId = `section-${index}`;
  const completed = state.completedSections.has(sectionId) ? ' completed' : '';
  const isOpen = state.openSection === sectionId;
  const preview = getPreview(step);

  let contentHtml = '';

  // Build tabs: first tab is always "Choose"/"Set"/"Add", rest from hints
  const inputTabLabel = step.input.type === 'toggle_group' ? 'Add Extras' :
                        step.input.type === 'slider_group' ? 'Set Size' : 'Choose';

  const hintTabs = step.hints || [];
  const hasTabs = hintTabs.length > 0;

  if (hasTabs) {
    contentHtml += `<div class="tabs">`;
    contentHtml += `<button class="tab active" onclick="showTab(this, '${sectionId}-input')">${inputTabLabel}</button>`;
    hintTabs.forEach((hint, hi) => {
      contentHtml += `<button class="tab" onclick="showTab(this, '${sectionId}-hint-${hi}')">${hint.tabLabel}</button>`;
    });
    contentHtml += `</div>`;
  }

  // Input panel
  contentHtml += `<div class="tab-panel show" id="${sectionId}-input">`;
  contentHtml += renderInput(step, sectionId);
  // Warnings
  if (step.warnings) {
    step.warnings.forEach(w => {
      contentHtml += `<div class="warning-card" id="${sectionId}-warning-${w.condition.replace(/[^a-z0-9]/gi,'')}" style="display:none;">
        <div class="warning-title">${w.icon} ${w.title}</div>
        <p>${w.text}</p>
      </div>`;
    });
  }
  contentHtml += `</div>`;

  // Hint panels
  hintTabs.forEach((hint, hi) => {
    contentHtml += `<div class="tab-panel" id="${sectionId}-hint-${hi}">`;
    contentHtml += renderHint(hint);
    contentHtml += `</div>`;
  });

  return `
    <div class="itab-section${completed}" id="${sectionId}">
      <div class="itab-header" onclick="toggleSection(${index})">
        <div class="itab-title">
          <span class="itab-number">${index + 1}</span>
          <div>
            <div class="itab-name">${step.title}</div>
            <div class="itab-preview" id="${sectionId}-preview">${preview}</div>
          </div>
        </div>
        <button class="i-button" id="${sectionId}-btn">i</button>
      </div>
      <div class="itab-content${isOpen ? ' show' : ''}" id="${sectionId}-content">
        ${contentHtml}
      </div>
    </div>`;
}

function renderEstimateSection(index) {
  const sectionId = `section-${index}`;
  const est = C.estimate;
  const isOpen = state.openSection === sectionId;
  const completed = state.completedSections.has(sectionId) ? ' completed' : '';

  let hintsHtml = '';
  if (est.hints) {
    est.hints.forEach(h => { hintsHtml += renderHintItem(h); });
  }

  return `
    <div class="itab-section${completed}" id="${sectionId}">
      <div class="itab-header" onclick="toggleSection(${index})">
        <div class="itab-title">
          <span class="itab-number">${index + 1}</span>
          <div>
            <div class="itab-name">${est.title}</div>
            <div class="itab-preview" id="${sectionId}-preview">${est.preview}</div>
          </div>
        </div>
        <button class="i-button" id="${sectionId}-btn">i</button>
      </div>
      <div class="itab-content${isOpen ? ' show' : ''}" id="${sectionId}-content">
        <div class="estimate-box">
          <div class="est-label">Estimated range</div>
          <div class="est-range" id="estRange">â€”</div>
          <div class="est-note" id="estNote">Complete the sections above to see your estimate</div>
          <div class="estimate-breakdown" id="estBreakdown"></div>
        </div>
        ${hintsHtml}
      </div>
    </div>`;
}

function renderLeadSection(index) {
  const sectionId = `section-${index}`;
  const lc = C.leadCapture;
  const isOpen = state.openSection === sectionId;
  const completed = state.completedSections.has(sectionId) ? ' completed' : '';

  let fieldsHtml = '';
  lc.fields.forEach(f => {
    const reqMark = f.required ? ' *' : '';
    if (f.type === 'textarea') {
      fieldsHtml += `<div class="form-group"><label>${f.label}${reqMark}</label><textarea id="form-${f.id}" placeholder="${f.placeholder}"></textarea></div>`;
    } else {
      fieldsHtml += `<div class="form-group"><label>${f.label}${reqMark}</label><input type="${f.type}" id="form-${f.id}" placeholder="${f.placeholder}"></div>`;
    }
  });

  return `
    <div class="itab-section${completed}" id="${sectionId}">
      <div class="itab-header" onclick="toggleSection(${index})">
        <div class="itab-title">
          <span class="itab-number">${index + 1}</span>
          <div>
            <div class="itab-name">${lc.title}</div>
            <div class="itab-preview" id="${sectionId}-preview">${lc.preview}</div>
          </div>
        </div>
        <button class="i-button" id="${sectionId}-btn">i</button>
      </div>
      <div class="itab-content${isOpen ? ' show' : ''}" id="${sectionId}-content">
        <div id="leadFormContainer">
          <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">${lc.subheading}</p>
          ${lc.showSummary ? `
            <div class="summary-box">
              <div class="summary-label">Your specs</div>
              <div class="summary-content" id="quoteSummary">Select your options above first</div>
            </div>` : ''}
          ${fieldsHtml}
          <button class="submit-btn" id="submitBtn" onclick="submitLead()">${lc.submitText}</button>
          ${lc.submitNote ? `<div style="text-align:center;margin-top:12px;font-size:0.75rem;color:var(--text-muted)">${lc.submitNote}</div>` : ''}
        </div>
        <div class="success-message" id="successMsg" style="display:none;">
          <div class="check-icon">âœ…</div>
          <h3>${lc.successMessage}</h3>
          <p>${lc.successSubtext}</p>
        </div>
      </div>
    </div>`;
}

// â”€â”€ INPUT RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderInput(step, sectionId) {
  const input = step.input;
  switch (input.type) {
    case 'select': return renderSelect(step, sectionId, input);
    case 'multi_select': return renderMultiSelect(step, sectionId, input);
    case 'slider_group': return renderSliders(step, sectionId, input);
    case 'toggle_group': return renderToggles(step, sectionId, input);
    default: return '<p>Unknown input type</p>';
  }
}

function renderSelect(step, sectionId, input) {
  const colsClass = input.columns === 2 ? ' cols-2' : '';
  let html = `<div class="option-grid${colsClass}">`;
  input.options.forEach((opt, i) => {
    const selected = state.answers[step.id] === opt.value ? ' selected' : '';
    const tagsHtml = opt.tags ? opt.tags.map(t =>
      `<span class="option-tag${t.highlight ? ' highlight' : ''}">${t.text}</span>`
    ).join('') : '';
    html += `
      <div class="option-card${selected}" onclick="selectOption('${step.id}', '${opt.value}', ${C.steps.indexOf(step)}, ${input.autoAdvance || false})">
        <div class="option-top">
          <span class="option-name">${opt.icon} ${opt.label}</span>
          ${opt.priceHint ? `<span class="option-price">${opt.priceHint}</span>` : ''}
        </div>
        ${opt.description ? `<div class="option-desc">${opt.description}</div>` : ''}
        ${tagsHtml ? `<div class="option-tags">${tagsHtml}</div>` : ''}
        <span class="option-check">âœ“ Selected</span>
      </div>`;
  });
  html += '</div>';
  return html;
}

function renderMultiSelect(step, sectionId, input) {
  // Similar to select but with multi-selection
  const colsClass = input.columns === 2 ? ' cols-2' : '';
  if (!state.answers[step.id]) state.answers[step.id] = [];
  let html = `<div class="option-grid${colsClass}">`;
  input.options.forEach(opt => {
    const selected = state.answers[step.id].includes(opt.value) ? ' selected' : '';
    html += `
      <div class="option-card${selected}" onclick="toggleMultiOption('${step.id}', '${opt.value}', this)">
        <div class="option-top">
          <span class="option-name">${opt.icon} ${opt.label}</span>
          ${opt.priceHint ? `<span class="option-price">${opt.priceHint}</span>` : ''}
        </div>
        ${opt.description ? `<div class="option-desc">${opt.description}</div>` : ''}
        <span class="option-check">âœ“ Selected</span>
      </div>`;
  });
  html += '</div>';
  if (input.optional) {
    html += `<button class="tab" style="margin-top:10px;width:100%;text-align:center;" onclick="skipStep(${C.steps.indexOf(step)})">Skip â€” none needed</button>`;
  }
  return html;
}

function renderSliders(step, sectionId, input) {
  let html = '';
  input.sliders.forEach(s => {
    const current = state.sliders[s.id];
    const displayValue = current ? current.label : s.default + (s.unit || '');
    html += `
      <div class="slider-group">
        <div class="slider-label">
          <span>${s.label}</span>
          <span class="slider-value" id="slider-val-${s.id}">${displayValue}</span>
        </div>
        <input type="range" id="slider-${s.id}" min="${s.min}" max="${s.max}" value="${s.default}" step="${s.step}"
               oninput="updateSlider('${s.id}', '${step.id}', ${C.steps.indexOf(step)}, this.value)">
        ${s.markers ? `<div class="slider-markers">${s.markers.map(m => `<span>${m}</span>`).join('')}</div>` : ''}
      </div>`;
  });
  return html;
}

function renderToggles(step, sectionId, input) {
  let html = '';
  input.toggles.forEach(t => {
    const isOn = state.toggles[t.id] ? ' on' : '';
    html += `
      <div class="toggle-row">
        <div class="toggle-info">
          <div class="toggle-name">${t.icon} ${t.label}</div>
          <div class="toggle-cost">${t.costHint}</div>
        </div>
        <div class="toggle-switch${isOn}" id="toggle-${t.id}" onclick="toggleExtra('${t.id}', '${step.id}', ${C.steps.indexOf(step)})">
          <div class="toggle-knob"></div>
        </div>
      </div>`;
  });
  return html;
}

// â”€â”€ HINT RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHint(hint) {
  switch (hint.type) {
    case 'comparison_table': return renderComparisonTable(hint);
    case 'tips': return renderTips(hint);
    case 'mixed': return renderMixed(hint);
    case 'custom_html': return hint.content;
    default: return '';
  }
}

function renderComparisonTable(hint) {
  let html = '<table class="compare-table"><thead><tr>';
  hint.columns.forEach(c => { html += `<th>${c}</th>`; });
  html += '</tr></thead><tbody>';
  hint.rows.forEach(row => {
    html += '<tr>';
    row.forEach((cell, i) => {
      const style = hint.cellStyles && hint.cellStyles[cell];
      const cls = style ? ` class="${style}"` : '';
      html += `<td${cls}>${cell}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  return html;
}

function renderTips(hint) {
  return hint.tips.map(t => `
    <div class="tip-card">
      <div class="tip-title">${t.icon} ${t.title}</div>
      <p>${t.text}</p>
    </div>`).join('');
}

function renderMixed(hint) {
  return hint.content.map(item => renderHintItem(item)).join('');
}

function renderHintItem(item) {
  switch (item.type) {
    case 'paragraph':
      return `<p style="color:var(--text-secondary);font-size:0.9rem;line-height:1.6;margin-bottom:12px;">${item.text}</p>`;
    case 'key_point':
      return `<div class="key-point"><div class="kp-label">${item.label}</div><p>${item.text}</p></div>`;
    case 'tip':
      return `<div class="tip-card"><div class="tip-title">${item.icon} ${item.title}</div><p>${item.text}</p></div>`;
    default:
      return '';
  }
}

// â”€â”€ INTERACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSection(index) {
  const sectionId = `section-${index}`;
  const content = document.getElementById(sectionId + '-content');
  const btn = document.getElementById(sectionId + '-btn');
  const isOpen = content && content.classList.contains('show');

  // Close all
  document.querySelectorAll('.itab-content').forEach(c => c.classList.remove('show'));
  document.querySelectorAll('.i-button').forEach(b => b.classList.remove('active'));

  if (!isOpen && content) {
    content.classList.add('show');
    if (btn) btn.classList.add('active');
    state.openSection = sectionId;
    state.completedSections.add(sectionId);
    updateProgress();

    setTimeout(() => {
      document.getElementById(sectionId).scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  } else {
    state.openSection = null;
  }
}

function showTab(btn, panelId) {
  const container = btn.closest('.itab-content');
  container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  container.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('show'));
  btn.classList.add('active');
  document.getElementById(panelId).classList.add('show');
}

function selectOption(stepId, value, stepIndex, autoAdvance) {
  state.answers[stepId] = value;
  const sectionId = `section-${stepIndex}`;

  // Update visual selection
  const section = document.getElementById(sectionId);
  section.querySelectorAll(`#${sectionId}-input .option-card`).forEach(c => c.classList.remove('selected'));
  // Find and select the right one
  const cards = section.querySelectorAll(`#${sectionId}-input .option-card`);
  const step = C.steps[stepIndex];
  step.input.options.forEach((opt, i) => {
    if (opt.value === value && cards[i]) cards[i].classList.add('selected');
  });

  // Mark completed
  section.classList.add('completed');
  state.completedSections.add(sectionId);

  // Update preview
  const opt = step.input.options.find(o => o.value === value);
  document.getElementById(sectionId + '-preview').innerHTML = `<span class="selected">âœ“ ${opt ? opt.label : value}</span>`;

  updateEstimate();
  updateQuoteSummary();
  updateProgress();
  checkWarnings();

  if (autoAdvance) {
    setTimeout(() => toggleSection(stepIndex + 1), 400);
  }
}

function toggleMultiOption(stepId, value, el) {
  if (!state.answers[stepId]) state.answers[stepId] = [];
  const idx = state.answers[stepId].indexOf(value);
  if (idx > -1) {
    state.answers[stepId].splice(idx, 1);
    el.classList.remove('selected');
  } else {
    state.answers[stepId].push(value);
    el.classList.add('selected');
  }
  updateEstimate();
  updateQuoteSummary();
}

function updateSlider(sliderId, stepId, stepIndex, rawValue) {
  const step = C.steps[stepIndex];
  const sliderConfig = step.input.sliders.find(s => s.id === sliderId);
  const raw = parseFloat(rawValue);

  if (sliderConfig.valueMap) {
    const mapped = sliderConfig.valueMap.find(v => v.value === raw);
    state.sliders[sliderId] = {
      raw, numeric: mapped ? mapped.numericValue : raw, label: mapped ? mapped.label : raw + (sliderConfig.unit || '')
    };
  } else {
    state.sliders[sliderId] = { raw, numeric: raw, label: raw + (sliderConfig.unit || '') };
  }

  // Update display
  document.getElementById(`slider-val-${sliderId}`).textContent = state.sliders[sliderId].label;

  // Mark completed & update preview
  const sectionId = `section-${stepIndex}`;
  document.getElementById(sectionId).classList.add('completed');
  state.completedSections.add(sectionId);

  // Build preview from all sliders in this step
  const previews = step.input.sliders.map(s => {
    const val = state.sliders[s.id];
    if (s.valueMap) return val.numeric + 'm';
    return val.raw + (s.unit || '');
  });
  document.getElementById(sectionId + '-preview').innerHTML = `<span class="selected">âœ“ ${previews.join(' Ã— ')}</span>`;

  updateEstimate();
  updateQuoteSummary();
  updateProgress();
  checkWarnings();
}

function toggleExtra(toggleId, stepId, stepIndex) {
  state.toggles[toggleId] = !state.toggles[toggleId];
  const el = document.getElementById(`toggle-${toggleId}`);
  el.classList.toggle('on');

  // Update preview
  const sectionId = `section-${stepIndex}`;
  const step = C.steps[stepIndex];
  const activeCount = step.input.toggles.filter(t => state.toggles[t.id]).length;

  if (activeCount > 0) {
    document.getElementById(sectionId + '-preview').innerHTML =
      `<span class="selected">âœ“ ${activeCount} extra${activeCount > 1 ? 's' : ''} added</span>`;
    document.getElementById(sectionId).classList.add('completed');
    state.completedSections.add(sectionId);
  } else {
    document.getElementById(sectionId + '-preview').textContent = step.preview;
    document.getElementById(sectionId).classList.remove('completed');
    state.completedSections.delete(sectionId);
  }

  updateEstimate();
  updateQuoteSummary();
  updateProgress();
}

function skipStep(stepIndex) {
  toggleSection(stepIndex + 1);
}

// â”€â”€ PRICING ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSliderNumeric(sliderId) {
  return state.sliders[sliderId] ? state.sliders[sliderId].numeric : 0;
}

function calculateEstimate() {
  const p = C.pricing;

  // Get base price from primary selection
  const primaryAnswer = state.answers[p.basePriceStep];
  if (!primaryAnswer || !p.basePrices[primaryAnswer]) return null;

  const base = p.basePrices[primaryAnswer];
  let low = base.low;
  let high = base.high;

  // Apply multipliers
  if (p.multipliers) {
    p.multipliers.forEach(m => {
      if (m.type === 'value_map') {
        const numericVal = getSliderNumeric(m.source);
        const mult = m.values[numericVal];
        if (mult !== undefined) {
          low *= mult;
          high *= mult;
        }
      }
    });
  }

  // Apply adjustments (additive from select steps)
  if (p.adjustments) {
    p.adjustments.forEach(adj => {
      const answer = state.answers[adj.source];
      if (answer && adj.type === 'additive') {
        const val = adj.values[answer] !== undefined ? adj.values[answer] : (adj.values._default || 0);
        low += val;
        high += val;
      }
    });
  }

  // Multiply by quantity
  const quantity = state.sliders[p.quantitySource] ? state.sliders[p.quantitySource].numeric : 1;
  low = Math.round(low * quantity);
  high = Math.round(high * quantity);

  // Build breakdown
  const breakdown = [];
  const primaryOpt = findOption(p.basePriceStep, primaryAnswer);
  const primaryLabel = primaryOpt ? primaryOpt.label : primaryAnswer;

  // Base line
  let baseLine = primaryLabel;
  if (p.quantitySource && state.sliders[p.quantitySource]) {
    baseLine += ` (${state.sliders[p.quantitySource].raw}${getSliderUnit(p.quantitySource)}`;
    // Add other slider values to label
    const baseStep = C.steps.find(s => s.input.type === 'slider_group' && s.input.sliders.some(sl => sl.id === p.quantitySource));
    if (baseStep) {
      baseStep.input.sliders.forEach(s => {
        if (s.id !== p.quantitySource && state.sliders[s.id]) {
          baseLine += ` Ã— ${state.sliders[s.id].numeric}m`;
        }
      });
    }
    baseLine += ')';
  }
  breakdown.push({ label: baseLine, low, high });

  // Extras
  let runningLow = low;
  let runningHigh = high;

  if (p.extras) {
    p.extras.forEach(extra => {
      if (!state.toggles[extra.id]) return;

      let extLow = 0, extHigh = 0;
      switch (extra.type) {
        case 'fixed':
          extLow = extra.low;
          extHigh = extra.high;
          break;
        case 'per_unit':
          extLow = Math.round(extra.lowPerUnit * quantity);
          extHigh = Math.round(extra.highPerUnit * quantity);
          break;
        case 'percentage':
          extLow = Math.round(runningLow * (extra.lowPercent / 100));
          extHigh = Math.round(runningHigh * (extra.highPercent / 100));
          break;
      }
      runningLow += extLow;
      runningHigh += extHigh;
      breakdown.push({ label: extra.breakdownLabel, low: extLow, high: extHigh, prefix: extra.type === 'percentage' ? '+' : '' });
    });
  }

  // Apply minimum
  runningLow = Math.max(runningLow, p.minimumPrice || 0);
  runningHigh = Math.max(runningHigh, p.minimumPrice || 0);

  // Round
  if (p.roundTo && p.roundTo > 0) {
    runningLow = Math.round(runningLow / p.roundTo) * p.roundTo;
    runningHigh = Math.round(runningHigh / p.roundTo) * p.roundTo;
  }

  return { low: runningLow, high: runningHigh, breakdown };
}

function findOption(stepId, value) {
  const step = C.steps.find(s => s.id === stepId);
  if (!step) return null;
  return step.input.options ? step.input.options.find(o => o.value === value) : null;
}

function getSliderUnit(sliderId) {
  for (const step of C.steps) {
    if (step.input.type === 'slider_group') {
      const s = step.input.sliders.find(sl => sl.id === sliderId);
      if (s) return s.unit || '';
    }
  }
  return '';
}

function updateEstimate() {
  const est = calculateEstimate();
  const rangeEl = document.getElementById('estRange');
  const noteEl = document.getElementById('estNote');
  const breakdownEl = document.getElementById('estBreakdown');
  const estSectionIndex = C.steps.length;
  const previewEl = document.getElementById(`section-${estSectionIndex}-preview`);

  if (!rangeEl) return; // Not yet rendered

  if (!est) {
    rangeEl.textContent = 'â€”';
    noteEl.textContent = 'Complete the sections above to see your estimate';
    breakdownEl.innerHTML = '';
    if (previewEl) previewEl.textContent = C.estimate.preview;
    return;
  }

  const rangeText = `$${est.low.toLocaleString()} â€“ $${est.high.toLocaleString()}`;
  rangeEl.textContent = rangeText;
  noteEl.textContent = C.estimate.note;

  if (C.pricing.showBreakdown && est.breakdown) {
    breakdownEl.innerHTML = est.breakdown.map(b => `
      <div class="breakdown-row">
        <span class="br-label">${b.label}</span>
        <span class="br-value">${b.prefix || ''}$${b.low.toLocaleString()} â€“ $${b.high.toLocaleString()}</span>
      </div>`).join('');
  }

  if (previewEl) {
    previewEl.innerHTML = `<span class="selected">âœ“ ${rangeText}</span>`;
  }
}

// â”€â”€ QUOTE SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateQuoteSummary() {
  const el = document.getElementById('quoteSummary');
  if (!el) return;

  let lines = [];

  C.steps.forEach(step => {
    if (step.input.type === 'select' && state.answers[step.id]) {
      const opt = findOption(step.id, state.answers[step.id]);
      lines.push(`${opt ? opt.icon : 'â€¢'} ${step.title}: <strong>${opt ? opt.label : state.answers[step.id]}</strong>`);
    }
    if (step.input.type === 'slider_group') {
      const vals = step.input.sliders.map(s => {
        const v = state.sliders[s.id];
        return v ? v.label : '';
      }).filter(Boolean);
      if (vals.length) lines.push(`ğŸ“ ${step.title}: <strong>${vals.join(' Ã— ')}</strong>`);
    }
    if (step.input.type === 'toggle_group') {
      const active = step.input.toggles.filter(t => state.toggles[t.id]);
      if (active.length) {
        lines.push(`â• Extras: ${active.map(t => t.icon + ' ' + t.label).join(', ')}`);
      }
    }
  });

  const est = calculateEstimate();
  if (est) {
    lines.push(`ğŸ’° Estimate: <strong>$${est.low.toLocaleString()} â€“ $${est.high.toLocaleString()}</strong>`);
  }

  el.innerHTML = lines.length ? lines.join('<br>') : 'Select your options above first';
}

// â”€â”€ WARNINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkWarnings() {
  const answers = state.answers;
  C.steps.forEach((step, i) => {
    if (!step.warnings) return;
    step.warnings.forEach(w => {
      const elId = `section-${i}-warning-${w.condition.replace(/[^a-z0-9]/gi,'')}`;
      const el = document.getElementById(elId);
      if (!el) return;
      try {
        const show = eval(w.condition);
        el.style.display = show ? 'block' : 'none';
      } catch(e) {
        el.style.display = 'none';
      }
    });
  });
}

// â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateProgress() {
  const totalSections = C.steps.length + (C.estimate ? 1 : 0) + (C.leadCapture && C.leadCapture.enabled ? 1 : 0);
  const completed = state.completedSections.size;
  const pct = (completed / totalSections) * 100;
  const fillEl = document.getElementById('progressFill');
  const textEl = document.getElementById('progressText');
  if (fillEl) fillEl.style.width = pct + '%';
  if (textEl) textEl.textContent = `${completed} of ${totalSections}`;
}

// â”€â”€ LEAD SUBMISSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitLead() {
  const lc = C.leadCapture;
  const formData = {};
  let missingRequired = false;

  lc.fields.forEach(f => {
    const el = document.getElementById(`form-${f.id}`);
    const val = el ? el.value.trim() : '';
    formData[f.id] = val;
    if (f.required && !val) missingRequired = true;
  });

  if (missingRequired) {
    alert('Just need the required fields filled in ğŸ‘');
    return;
  }

  const btn = document.getElementById('submitBtn');
  btn.textContent = 'Sending...';
  btn.disabled = true;

  // Build selections summary
  let selections = '';
  C.steps.forEach(step => {
    if (step.input.type === 'select' && state.answers[step.id]) {
      const opt = findOption(step.id, state.answers[step.id]);
      selections += `${step.title}: ${opt ? opt.label : state.answers[step.id]}\n`;
    }
    if (step.input.type === 'slider_group') {
      const vals = step.input.sliders.map(s => `${s.label}: ${state.sliders[s.id] ? state.sliders[s.id].label : ''}`);
      selections += vals.join(', ') + '\n';
    }
    if (step.input.type === 'toggle_group') {
      const active = step.input.toggles.filter(t => state.toggles[t.id]).map(t => t.label);
      if (active.length) selections += `Extras: ${active.join(', ')}\n`;
    }
  });

  const est = calculateEstimate();
  const estText = est ? `$${est.low.toLocaleString()} â€“ $${est.high.toLocaleString()}` : 'Not calculated';

  try {
    if (lc.delivery.method === 'web3forms') {
      const payload = {
        access_key: lc.delivery.web3formsKey,
        subject: lc.delivery.emailSubject.replace('{business.name}', C.business.name),
        from_name: `${C.business.name} Quote Widget`,
        to: lc.delivery.notifyEmail,
        message: `NEW QUOTE ENQUIRY\n==================\n${Object.entries(formData).map(([k,v]) => `${k}: ${v}`).join('\n')}\n\nSELECTIONS\n==================\n${selections}\nESTIMATE SHOWN: ${estText}`.trim(),
        ...formData,
        estimate_range: estText,
        selections_summary: selections,
      };

      await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
    }
  } catch (err) {
    console.error('Submit error:', err);
  }

  // Show success regardless (better UX)
  document.getElementById('leadFormContainer').style.display = 'none';
  document.getElementById('successMsg').style.display = 'block';

  const leadSectionIndex = C.steps.length + (C.estimate ? 1 : 0);
  const sectionId = `section-${leadSectionIndex}`;
  document.getElementById(sectionId).classList.add('completed');
  state.completedSections.add(sectionId);
  document.getElementById(sectionId + '-preview').innerHTML = '<span class="selected">âœ“ Sent!</span>';
  updateProgress();
}

// â”€â”€ PREVIEW HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPreview(step) {
  if (step.input.type === 'select' && state.answers[step.id]) {
    const opt = step.input.options.find(o => o.value === state.answers[step.id]);
    return `<span class="selected">âœ“ ${opt ? opt.label : state.answers[step.id]}</span>`;
  }
  return step.preview;
}

// â”€â”€ GO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>

</body>
</html>
